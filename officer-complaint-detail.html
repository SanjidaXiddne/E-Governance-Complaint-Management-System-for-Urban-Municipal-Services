<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Complaint Details - Officer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="dashboard.css" />
    <style>
      .technician-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
      }
      .technician-card:hover {
        border-color: #0d6efd;
        background-color: #f8f9ff;
        transform: translateY(-2px);
      }
      .technician-card.selected {
        border-color: #0d6efd;
        background-color: #e7f1ff;
      }
      .technician-card.selected .check-icon {
        display: flex;
      }
      .check-icon {
        display: none;
        position: absolute;
        top: 10px;
        right: 10px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #0d6efd;
        color: white;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }
      .availability-badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
      }
      .assignment-info {
        background: linear-gradient(135deg, #e7f1ff 0%, #f0f7ff 100%);
        border-left: 4px solid #0d6efd;
      }

      /* Enhanced Timeline Styles */
      .timeline {
        position: relative;
      }
      .timeline-item {
        position: relative;
        padding-left: 40px;
        padding-bottom: 24px;
        border-left: 2px solid #e9ecef;
        margin-left: 10px;
      }
      .timeline-item:last-child {
        border-left: 2px solid transparent;
        padding-bottom: 0;
      }
      .timeline-marker {
        position: absolute;
        left: -11px;
        top: 0;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #0d6efd;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }
      .timeline-item.submitted .timeline-marker {
        background: #3b82f6;
      }
      .timeline-item.acknowledged .timeline-marker {
        background: #06b6d4;
      }
      .timeline-item.assigned .timeline-marker {
        background: #8b5cf6;
      }
      .timeline-item.in-progress .timeline-marker {
        background: #f59e0b;
      }
      .timeline-item.resolved .timeline-marker {
        background: #10b981;
      }
      .timeline-item.rejected .timeline-marker {
        background: #ef4444;
      }

      .timeline-date {
        font-size: 0.75rem;
        color: #6c757d;
        margin-bottom: 4px;
      }
      .timeline-content {
        background: #f8f9fa;
        padding: 12px 16px;
        border-radius: 8px;
        transition: all 0.3s ease;
      }
      .timeline-item:hover .timeline-content {
        background: #f1f5f9;
      }
      .timeline-new-entry {
        animation: timelineSlideIn 0.5s ease;
      }
      .timeline-new-entry .timeline-content {
        background: #fef3c7;
      }
      @keyframes timelineSlideIn {
        from {
          transform: translateX(-20px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.7rem;
        color: #10b981;
        background: rgba(16, 185, 129, 0.1);
        padding: 3px 8px;
        border-radius: 12px;
      }
      .live-dot {
        width: 6px;
        height: 6px;
        background: #10b981;
        border-radius: 50%;
        animation: livePulse 2s infinite;
      }
      @keyframes livePulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(0.8);
        }
      }

      .loading-spinner {
        display: none;
      }
      .btn-loading .loading-spinner {
        display: inline-block;
      }
      .btn-loading .btn-text {
        display: none;
      }

      .status-update-alert {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        animation: slideUp 0.4s ease;
      }
      @keyframes slideUp {
        from {
          transform: translate(-50%, 100px);
          opacity: 0;
        }
        to {
          transform: translate(-50%, 0);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top dashboard-nav">
      <div class="container-fluid px-4">
        <a
          class="navbar-brand d-flex align-items-center"
          href="officer-dashboard.html"
        >
          <img
            src="images/govt.png"
            alt="Logo"
            width="32"
            height="32"
            class="me-2"
          />
          Officers Portal
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#officerNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="officerNav">
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item">
              <a class="nav-link" href="officer-dashboard.html">
                <i class="fas fa-th-large"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="officer-complaint-detail.html">
                <i class="fas fa-file-alt"></i> Complaints
              </a>
            </li>
            <li class="nav-item ms-lg-3">
              <div class="d-flex align-items-center">
                <div class="user-avatar bg-primary text-white me-2">OJ</div>
                <div class="d-none d-lg-block">
                  <div class="small fw-bold">Officer Jane</div>
                </div>
              </div>
            </li>
            <li class="nav-item ms-3">
              <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
              </button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
      <div class="container-fluid px-4">
        <div class="mb-4">
          <a
            href="officer-dashboard.html"
            class="btn btn-outline-secondary btn-sm mb-3"
          >
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
          </a>
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="fw-bold mb-1" id="complaintTitle">
                Complaint #CMPT-130
              </h4>
              <span class="badge bg-danger" id="statusBadge">New</span>
              <span class="text-muted small ms-2" id="submittedDate"
                >Submitted on Aug 24, 2025</span
              >
            </div>
            <div class="d-flex gap-2">
              <button
                class="btn btn-outline-primary btn-sm"
                onclick="window.print()"
              >
                <i class="fas fa-print me-2"></i>Print
              </button>
              <button
                class="btn btn-primary btn-sm"
                data-bs-toggle="modal"
                data-bs-target="#updateStatusModal"
              >
                <i class="fas fa-edit me-2"></i>Update Status
              </button>
            </div>
          </div>
        </div>

        <div class="row g-4">
          <!-- Left Column: Details -->
          <div class="col-lg-8">
            <!-- Assignment Info (Initially Hidden) -->
            <div
              class="card border-0 shadow-sm mb-4 assignment-info"
              id="assignmentInfoCard"
              style="display: none"
            >
              <div class="card-body p-4">
                <div class="d-flex align-items-center">
                  <div class="rounded-circle bg-primary text-white p-3 me-3">
                    <i class="fas fa-user-hard-hat fa-lg"></i>
                  </div>
                  <div class="flex-grow-1">
                    <div class="small text-muted">Assigned Technician</div>
                    <div class="fw-bold fs-5" id="assignedTechName">-</div>
                    <div class="small text-muted">
                      <span id="assignedTechId">-</span> â€¢
                      <span id="assignedTechPhone">-</span>
                    </div>
                  </div>
                  <div class="text-end">
                    <span
                      class="badge bg-warning text-dark"
                      id="assignedTechStatus"
                      >In Progress</span
                    >
                    <div class="small text-muted mt-1" id="assignedDate">-</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card border-0 shadow-sm mb-4">
              <div class="card-body p-4">
                <div
                  class="d-flex align-items-center mb-4 p-3 bg-light rounded"
                  id="citizenInfo"
                >
                  <div
                    class="user-avatar bg-secondary text-white me-3"
                    id="citizenInitials"
                  >
                    JD
                  </div>
                  <div>
                    <div class="small text-muted">Reported by</div>
                    <div class="fw-bold" id="citizenName">John Doe</div>
                    <div class="small text-muted" id="citizenContact">
                      john@example.com | +880 1700 000000
                    </div>
                  </div>
                </div>

                <h6 class="fw-bold text-uppercase text-muted small mb-3">
                  Issue Description
                </h6>
                <p class="mb-4" id="complaintDescription">
                  Loading complaint details...
                </p>

                <div class="row g-4 mb-4">
                  <div class="col-md-6">
                    <div class="d-flex align-items-center">
                      <div class="rounded-circle bg-light p-3 me-3">
                        <i class="fas fa-map-marker-alt text-danger fa-lg"></i>
                      </div>
                      <div>
                        <div class="small text-muted">Location</div>
                        <div class="fw-medium" id="complaintLocation">
                          Gulshan-2, Dhaka
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="d-flex align-items-center">
                      <div class="rounded-circle bg-light p-3 me-3">
                        <i class="fas fa-tag text-primary fa-lg"></i>
                      </div>
                      <div>
                        <div class="small text-muted">Category</div>
                        <div class="fw-medium" id="complaintCategory">
                          Water Leakage
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <h6 class="fw-bold text-uppercase text-muted small mb-3">
                  Attached Photos
                </h6>
                <div class="row g-2">
                  <div class="col-4 col-md-3">
                    <img
                      src="images/u1.jpg"
                      class="img-fluid rounded border"
                      alt="Evidence 1"
                    />
                  </div>
                  <div class="col-4 col-md-3">
                    <img
                      src="images/u2.jpg"
                      class="img-fluid rounded border"
                      alt="Evidence 2"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column: Timeline & Actions -->
          <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-4">
              <div class="card-header bg-white border-bottom p-3">
                <h6 class="fw-bold mb-0">Action Required</h6>
              </div>
              <div class="card-body p-4">
                <div class="d-grid gap-2">
                  <button
                    class="btn btn-outline-primary"
                    id="assignTechnicianBtn"
                    onclick="openTechnicianModal()"
                  >
                    <i class="fas fa-user-plus me-2"></i>Assign to Technician
                  </button>
                  <button
                    class="btn btn-outline-danger"
                    id="rejectBtn"
                    onclick="rejectComplaint()"
                  >
                    <i class="fas fa-times-circle me-2"></i>Reject Complaint
                  </button>
                </div>
              </div>
            </div>

            <div class="card border-0 shadow-sm">
              <div class="card-header bg-white border-bottom p-3">
                <div class="d-flex justify-content-between align-items-center">
                  <h6 class="fw-bold mb-0">Status Timeline</h6>
                  <div class="live-indicator">
                    <!-- <div class="live-dot"></div>
                    <span>Live</span> -->
                  </div>
                </div>
              </div>
              <div class="card-body p-4">
                <div class="timeline" id="statusTimeline">
                  <div class="text-center py-3">
                    <i class="fas fa-spinner fa-spin text-muted"></i>
                    <p class="small text-muted mb-0 mt-2">
                      Loading timeline...
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Technician Selection Modal -->
    <div
      class="modal fade"
      id="technicianModal"
      tabindex="-1"
      aria-labelledby="technicianModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0 pb-0">
            <div>
              <h5 class="modal-title fw-bold" id="technicianModalLabel">
                <i class="fas fa-user-hard-hat text-primary me-2"></i>Assign to
                Technician
              </h5>
              <p class="text-muted small mb-0">
                Select an available technician for this complaint
              </p>
            </div>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body pt-3">
            <div class="row g-3 mb-4">
              <div class="col-md-8">
                <div class="input-group">
                  <span class="input-group-text bg-white border-end-0">
                    <i class="fas fa-search text-muted"></i>
                  </span>
                  <input
                    type="text"
                    class="form-control border-start-0"
                    id="technicianSearch"
                    placeholder="Search technicians..."
                    oninput="filterTechnicians()"
                  />
                </div>
              </div>
              <div class="col-md-4">
                <select
                  class="form-select"
                  id="specialtyFilter"
                  onchange="filterTechnicians()"
                >
                  <option value="">All Specialties</option>
                  <option value="plumbing">Plumbing</option>
                  <option value="electrical">Electrical</option>
                  <option value="road">Road Repair</option>
                  <option value="sanitation">Sanitation</option>
                </select>
              </div>
            </div>

            <div class="technician-list" id="technicianList">
              <!-- Technicians will be loaded from MongoDB -->
              <div class="text-center py-4" id="technicianLoading">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading technicians...</span>
                </div>
                <p class="text-muted mt-2">
                  Loading technicians from database...
                </p>
              </div>
            </div>

            <div
              class="text-center py-4 text-muted"
              id="noResultsMessage"
              style="display: none"
            >
              <i class="fas fa-search fa-2x mb-3"></i>
              <p>No technicians found matching your search criteria.</p>
            </div>

            <div class="mt-4">
              <label class="form-label fw-bold"
                >Assignment Notes (Optional)</label
              >
              <textarea
                class="form-control"
                id="assignmentNotes"
                rows="2"
                placeholder="Add any special instructions..."
              ></textarea>
            </div>
          </div>
          <div class="modal-footer border-0">
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="confirmAssignBtn"
              onclick="confirmAssignment()"
              disabled
            >
              <span class="loading-spinner"
                ><i class="fas fa-spinner fa-spin me-2"></i
              ></span>
              <span class="btn-text"
                ><i class="fas fa-check me-2"></i>Confirm Assignment</span
              >
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Update Status Modal -->
    <div class="modal fade" id="updateStatusModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Update Status</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label class="form-label">New Status</label>
                <select class="form-select" id="newStatusSelect">
                  <option value="acknowledged">Acknowledged</option>
                  <option value="in-progress">In Progress</option>
                  <option value="resolved">Resolved</option>
                  <option value="rejected">Rejected</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Comments</label>
                <textarea
                  class="form-control"
                  id="statusComments"
                  rows="3"
                  placeholder="Add comments..."
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="updateStatus()"
            >
              Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Reject Modal -->
    <div class="modal fade" id="rejectModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header border-0">
            <h5 class="modal-title text-danger">
              <i class="fas fa-exclamation-triangle me-2"></i>Reject Complaint
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>Are you sure you want to reject this complaint?</p>
            <div class="mb-3">
              <label class="form-label fw-bold">Rejection Reason *</label>
              <select class="form-select mb-3" id="rejectionReason">
                <option value="">Select a reason...</option>
                <option value="Duplicate Complaint">Duplicate Complaint</option>
                <option value="Invalid Information">
                  Invalid/Incomplete Information
                </option>
                <option value="Out of Scope">Out of Municipality Scope</option>
                <option value="Already Resolved">Already Resolved</option>
                <option value="Other">Other</option>
              </select>
              <textarea
                class="form-control"
                id="rejectionNotes"
                rows="3"
                placeholder="Additional notes..."
              ></textarea>
            </div>
          </div>
          <div class="modal-footer border-0">
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="confirmRejection()"
            >
              <i class="fas fa-times-circle me-2"></i>Reject Complaint
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Real-time Complaint Service -->
    <script src="complaint-service.js"></script>
    <!-- API Service for MongoDB -->
    <script src="api-service.js"></script>
    <script>
      // State management
      let currentComplaintId = "CMPT-130";
      let currentComplaint = null;
      let selectedTechnician = null;
      let technicianModal, rejectModal, updateStatusModal;

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        // Get complaint ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const idFromUrl = urlParams.get("id");
        if (idFromUrl) {
          currentComplaintId = idFromUrl;
        }

        // Initialize modals
        technicianModal = new bootstrap.Modal(
          document.getElementById("technicianModal")
        );
        rejectModal = new bootstrap.Modal(
          document.getElementById("rejectModal")
        );
        updateStatusModal = new bootstrap.Modal(
          document.getElementById("updateStatusModal")
        );

        // Load complaint data from MongoDB
        loadComplaintData();

        // Subscribe to real-time updates from both services
        ComplaintService.subscribe(handleRealtimeUpdate);
        ApiService.subscribe(handleRealtimeUpdate);
      });

      // Load complaint data from MongoDB via API
      async function loadComplaintData() {
        try {
          // Fetch from MongoDB API
          const complaint = await ApiService.getComplaintById(
            currentComplaintId
          );

          if (complaint) {
            // Map MongoDB format to local format
            currentComplaint = {
              id: complaint.complaintId || complaint.id,
              category: complaint.category,
              categoryLabel: complaint.categoryLabel,
              description: complaint.description,
              location: complaint.location,
              status: complaint.status,
              priority: complaint.priority,
              citizen: {
                name: complaint.citizen?.name || "Unknown",
                email: complaint.citizen?.email || "",
                phone: complaint.citizen?.phone || "",
                initials: ApiService.getInitials(
                  complaint.citizen?.name || "U"
                ),
              },
              assignedTo: complaint.assignedTo,
              timeline: complaint.timeline || [],
              createdAt: complaint.createdAt,
              updatedAt: complaint.updatedAt,
              resolvedAt: complaint.resolvedAt,
            };
            currentComplaintId = currentComplaint.id;
            updateComplaintDisplay();
            renderTimeline();
          } else {
            // Fallback to localStorage
            loadFromLocalStorage();
          }
        } catch (err) {
          console.error("Error loading complaint from API:", err);
          // Fallback to localStorage
          loadFromLocalStorage();
        }
      }

      // Fallback to load from localStorage
      function loadFromLocalStorage() {
        currentComplaint =
          ComplaintService.getComplaintById(currentComplaintId);

        if (!currentComplaint) {
          // Try without CMPT- prefix
          currentComplaint = ComplaintService.getComplaintById(
            "CMPT-" + currentComplaintId
          );
          if (currentComplaint) {
            currentComplaintId = currentComplaint.id;
          }
        }

        if (currentComplaint) {
          updateComplaintDisplay();
          renderTimeline();
        } else {
          document.getElementById("complaintDescription").textContent =
            "Complaint not found.";
        }
      }

      // Update complaint display
      function updateComplaintDisplay() {
        document.getElementById("complaintTitle").textContent =
          "Complaint #" + currentComplaint.id;
        document.getElementById("submittedDate").textContent =
          "Submitted on " +
          ComplaintService.formatDate(currentComplaint.createdAt);
        document.getElementById("citizenName").textContent =
          currentComplaint.citizen.name;
        document.getElementById("citizenInitials").textContent =
          currentComplaint.citizen.initials;
        document.getElementById("citizenContact").textContent =
          currentComplaint.citizen.email +
          " | " +
          currentComplaint.citizen.phone;
        document.getElementById("complaintDescription").textContent =
          currentComplaint.description;
        document.getElementById("complaintLocation").textContent =
          currentComplaint.location;
        document.getElementById("complaintCategory").textContent =
          currentComplaint.categoryLabel;

        // Update status badge
        updateStatusBadge(currentComplaint.status);

        // Show assignment info if assigned
        if (currentComplaint.assignedTo) {
          showAssignmentInfo(currentComplaint.assignedTo);
        }

        // Update action buttons based on status
        updateActionButtons();
      }

      // Render timeline with real-time data from MongoDB
      function renderTimeline() {
        // Use timeline from currentComplaint (from MongoDB) or fallback to local
        const timeline =
          currentComplaint?.timeline ||
          ComplaintService.getTimeline(currentComplaintId);
        const container = document.getElementById("statusTimeline");

        if (timeline.length === 0) {
          container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <p class="mb-0 small">No timeline entries yet</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = timeline
          .map((entry, index) => {
            const config = ComplaintService.getTimelineTypeConfig(entry.type);
            const isNew =
              index === 0 &&
              Date.now() - new Date(entry.timestamp).getTime() < 5000;

            return `
                    <div class="timeline-item ${entry.type} ${
              isNew ? "timeline-new-entry" : ""
            }" data-entry-id="${entry.id}">
                        <div class="timeline-marker">
                            <i class="fas ${
                              config.icon
                            }" style="color: white; font-size: 8px;"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-date">${ComplaintService.formatDateTime(
                              entry.timestamp
                            )}</div>
                            <div class="fw-medium">${entry.title}</div>
                            <div class="small text-muted">${
                              entry.description
                            }</div>
                            ${
                              entry.actor
                                ? `<div class="small text-muted mt-1"><i class="fas fa-user me-1"></i>${entry.actor} (${entry.actorRole})</div>`
                                : ""
                            }
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // Handle real-time updates - reload from MongoDB
      async function handleRealtimeUpdate(type, data) {
        console.log("Officer Detail - Real-time update:", type, data);

        // Normalize ID across different event formats
        const eventComplaintId = data.complaintId || data.id || data._id;
        const isCurrentComplaint =
          eventComplaintId === currentComplaintId ||
          eventComplaintId === `CMPT-${currentComplaintId}` ||
          `CMPT-${eventComplaintId}` === currentComplaintId;

        switch (type) {
          case "TIMELINE_UPDATED":
            if (isCurrentComplaint) {
              await loadComplaintData();
              ComplaintService.showNotification(
                "Timeline updated with new entry",
                "info"
              );
            }
            break;

          case "STATUS_CHANGED":
          case "COMPLAINT_STATUS_CHANGED":
            if (isCurrentComplaint) {
              await loadComplaintData();
              const newStatus = data.newStatus || data.status;
              ComplaintService.showNotification(
                `Status changed to ${ComplaintService.getStatusLabel(
                  newStatus
                )}`,
                "warning"
              );
            }
            break;

          case "COMPLAINT_UPDATED":
            if (isCurrentComplaint) {
              await loadComplaintData();
            }
            break;

          case "TASK_ASSIGNED":
          case "COMPLAINT_ASSIGNED":
            if (isCurrentComplaint) {
              await loadComplaintData();
              const techName =
                data.technician?.name || data.technicianName || "a technician";
              ComplaintService.showNotification(
                `Task assigned to ${techName}`,
                "success"
              );
            }
            break;

          case "TASK_STARTED":
          case "PROGRESS_UPDATE":
            if (isCurrentComplaint) {
              await loadComplaintData();
              ComplaintService.showNotification(
                type === "TASK_STARTED"
                  ? "Technician has started working on this task!"
                  : "Technician posted a progress update",
                "info"
              );
            }
            break;

          case "TASK_COMPLETED":
            if (isCurrentComplaint) {
              await loadComplaintData();
              ComplaintService.showNotification(
                "ðŸŽ‰ Task has been marked as complete by the technician!",
                "success"
              );
            }
            break;

          case "DATA_RESET":
            await loadComplaintData();
            break;
        }
      }

      // Update status badge
      function updateStatusBadge(status) {
        const badge = document.getElementById("statusBadge");
        badge.className =
          "badge " + ComplaintService.getStatusBadgeClass(status);
        badge.textContent = ComplaintService.getStatusLabel(status);
      }

      // Update action buttons based on status
      function updateActionButtons() {
        const assignBtn = document.getElementById("assignTechnicianBtn");
        const rejectBtn = document.getElementById("rejectBtn");

        if (
          currentComplaint.status === "resolved" ||
          currentComplaint.status === "rejected"
        ) {
          assignBtn.disabled = true;
          rejectBtn.disabled = true;
        } else if (currentComplaint.assignedTo) {
          assignBtn.innerHTML =
            '<i class="fas fa-user-edit me-2"></i>Reassign Technician';
          assignBtn.classList.replace(
            "btn-outline-primary",
            "btn-outline-warning"
          );
        }
      }

      // Show assignment info card
      function showAssignmentInfo(technician) {
        const card = document.getElementById("assignmentInfoCard");
        document.getElementById("assignedTechName").textContent =
          technician.name;
        document.getElementById("assignedTechId").textContent = technician.id;
        document.getElementById("assignedTechPhone").textContent =
          technician.phone || "-";
        document.getElementById("assignedDate").textContent =
          "Assigned " +
          ComplaintService.formatDateTime(currentComplaint.updatedAt);

        // Update technician status badge based on complaint status
        const statusBadge = document.getElementById("assignedTechStatus");
        if (statusBadge && currentComplaint && currentComplaint.status) {
          const status = currentComplaint.status;
          const statusMap = {
            resolved: { text: "Complete", class: "bg-success" },
            "in-progress": {
              text: "In Progress",
              class: "bg-warning text-dark",
            },
            acknowledged: { text: "Acknowledged", class: "bg-info text-dark" },
            new: { text: "Pending", class: "bg-secondary" },
            rejected: { text: "Rejected", class: "bg-danger" },
          };
          const cfg = statusMap[status] || statusMap["new"];
          statusBadge.textContent = cfg.text;
          statusBadge.className = `badge ${cfg.class}`;
        }

        card.style.display = "block";
      }

      // Load technicians from MongoDB
      let allTechnicians = [];

      async function loadTechnicians() {
        const listContainer = document.getElementById("technicianList");

        // Show loading state
        listContainer.innerHTML = `
          <div class="text-center py-4" id="technicianLoading">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading technicians...</span>
            </div>
            <p class="text-muted mt-2">Loading technicians from database...</p>
          </div>
        `;

        try {
          // Fetch technicians from API
          allTechnicians = await ApiService.getUsersByRole("technician");
          console.log("Loaded technicians from MongoDB:", allTechnicians);

          if (!allTechnicians || allTechnicians.length === 0) {
            listContainer.innerHTML = `
              <div class="text-center py-4 text-muted">
                <i class="fas fa-user-slash fa-2x mb-3"></i>
                <p>No technicians found in the database.</p>
              </div>
            `;
            return;
          }

          // Fetch task counts for each technician (in parallel)
          const taskCountPromises = allTechnicians.map(async (tech) => {
            const techId = tech.technicianId || tech.id || tech._id;
            try {
              const complaints = await ApiService.getComplaintsByTechnician(
                techId
              );
              // Count tasks by status
              const inProgress = complaints.filter(
                (c) => c.status === "in-progress" || c.status === "assigned"
              ).length;
              const total = complaints.length;
              return { techId, inProgress, total };
            } catch (err) {
              console.error(`Error fetching tasks for ${techId}:`, err);
              return { techId, inProgress: 0, total: 0 };
            }
          });

          const taskCounts = await Promise.all(taskCountPromises);

          // Create a map for quick lookup
          const taskCountMap = {};
          taskCounts.forEach((tc) => {
            taskCountMap[tc.techId] = tc;
          });

          // Attach task counts to technicians
          allTechnicians = allTechnicians.map((tech) => {
            const techId = tech.technicianId || tech.id || tech._id;
            const counts = taskCountMap[techId] || { inProgress: 0, total: 0 };
            return {
              ...tech,
              tasksInProgress: counts.inProgress,
              totalTasks: counts.total,
            };
          });

          console.log("Technicians with task counts:", allTechnicians);

          // Render technician cards
          renderTechnicianList(allTechnicians);
        } catch (err) {
          console.error("Error loading technicians:", err);
          listContainer.innerHTML = `
            <div class="text-center py-4 text-danger">
              <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
              <p>Failed to load technicians. Please try again.</p>
            </div>
          `;
        }
      }

      function renderTechnicianList(technicians) {
        const listContainer = document.getElementById("technicianList");
        const colors = [
          "bg-success",
          "bg-primary",
          "bg-warning",
          "bg-info",
          "bg-secondary",
        ];

        listContainer.innerHTML = technicians
          .map((tech, index) => {
            const initials = ApiService.getInitials
              ? ApiService.getInitials(tech.name)
              : tech.name
                  .split(" ")
                  .map((n) => n[0])
                  .join("")
                  .toUpperCase()
                  .slice(0, 2);
            const colorClass = colors[index % colors.length];
            const textClass =
              colorClass === "bg-warning" ? "text-dark" : "text-white";

            // Task count display
            const tasksInProgress = tech.tasksInProgress || 0;
            const taskBadgeClass =
              tasksInProgress === 0
                ? "bg-light text-dark"
                : tasksInProgress <= 2
                ? "bg-info text-white"
                : "bg-danger text-white";

            return `
            <div
              class="card technician-card mb-3 position-relative"
              data-tech-id="${tech.technicianId || tech.id || tech._id}"
              data-name="${tech.name}"
              data-phone="${tech.phone || ""}"
              data-specialty="${(tech.specialty || "general").toLowerCase()}"
              onclick="selectTechnician(this)"
            >
              <div class="card-body p-3">
                <div class="d-flex align-items-center">
                  <div class="user-avatar ${colorClass} ${textClass} me-3">${initials}</div>
                  <div class="flex-grow-1">
                    <div class="fw-bold">${tech.name}</div>
                    <div class="small text-muted">
                      <i class="fas fa-tools me-1"></i>${
                        tech.specialty || "General"
                      }
                    </div>
                    <div class="small text-muted">
                      <i class="fas fa-phone me-1"></i>${tech.phone || "N/A"}
                    </div>
                  </div>
                  <div class="text-end">
                    <span class="badge ${
                      tech.status === "active"
                        ? "bg-success"
                        : "bg-warning text-dark"
                    } availability-badge">
                      ${tech.status === "active" ? "Available" : "Busy"}
                    </span>
                    <div class="small mt-1">
                      <span class="badge ${taskBadgeClass}" title="Tasks currently in progress">
                        <i class="fas fa-tasks me-1"></i>${tasksInProgress} task${
              tasksInProgress !== 1 ? "s" : ""
            } in progress
                      </span>
                    </div>
                    <div class="small text-muted mt-1">
                      <i class="fas fa-id-badge me-1"></i>${
                        tech.technicianId || "N/A"
                      }
                    </div>
                  </div>
                  <div class="check-icon ms-3">
                    <i class="fas fa-check"></i>
                  </div>
                </div>
              </div>
            </div>
          `;
          })
          .join("");
      }

      // Open technician modal - loads from MongoDB
      async function openTechnicianModal() {
        selectedTechnician = null;
        document.getElementById("confirmAssignBtn").disabled = true;
        document.getElementById("assignmentNotes").value = "";
        document.getElementById("technicianSearch").value = "";
        document.getElementById("specialtyFilter").value = "";

        // Show modal first
        technicianModal.show();

        // Load technicians from MongoDB
        await loadTechnicians();
      }

      // Select technician
      function selectTechnician(cardElement) {
        document
          .querySelectorAll(".technician-card")
          .forEach((card) => card.classList.remove("selected"));
        cardElement.classList.add("selected");
        selectedTechnician = {
          id: cardElement.dataset.techId,
          name: cardElement.dataset.name,
          phone: cardElement.dataset.phone,
          specialty: cardElement.dataset.specialty,
        };
        document.getElementById("confirmAssignBtn").disabled = false;
      }

      // Filter technicians
      function filterTechnicians() {
        const searchTerm = document
          .getElementById("technicianSearch")
          .value.toLowerCase();
        const specialtyFilter = document
          .getElementById("specialtyFilter")
          .value.toLowerCase();
        const cards = document.querySelectorAll(".technician-card");
        let visibleCount = 0;

        cards.forEach((card) => {
          const name = (card.dataset.name || "").toLowerCase();
          const specialty = (card.dataset.specialty || "").toLowerCase();
          const matchesSearch =
            name.includes(searchTerm) || specialty.includes(searchTerm);
          const matchesSpecialty =
            !specialtyFilter || specialty.includes(specialtyFilter);

          if (matchesSearch && matchesSpecialty) {
            card.style.display = "block";
            visibleCount++;
          } else {
            card.style.display = "none";
          }
        });

        document.getElementById("noResultsMessage").style.display =
          visibleCount === 0 ? "block" : "none";
      }

      // Confirm assignment - saves to MongoDB
      async function confirmAssignment() {
        if (!selectedTechnician) return;

        const btn = document.getElementById("confirmAssignBtn");
        const notes = document.getElementById("assignmentNotes").value;
        const officerName =
          sessionStorage.getItem("userName") || "Officer Jane";
        const isReassignment = currentComplaint.assignedTo != null;

        btn.classList.add("btn-loading");
        btn.disabled = true;

        try {
          // Assign via API (saves to MongoDB)
          const result = await ApiService.assignComplaint(
            currentComplaintId,
            selectedTechnician.id,
            selectedTechnician.name,
            officerName,
            "officer"
          );

          if (result && result.success) {
            console.log("Assignment saved to MongoDB:", result);

            // Update local state
            currentComplaint.assignedTo = {
              id: selectedTechnician.id,
              name: selectedTechnician.name,
            };
            currentComplaint.status = "in-progress";

            // Update UI
            showAssignmentInfo(currentComplaint.assignedTo);
            updateStatusBadge("in-progress");
            updateActionButtons();

            // Reload to get fresh timeline
            await loadComplaintData();

            ComplaintService.showNotification(
              isReassignment
                ? `Complaint reassigned to ${selectedTechnician.name}!`
                : `Complaint assigned to ${selectedTechnician.name}!`,
              "success"
            );
          } else {
            throw new Error(result?.error || "Assignment failed");
          }
        } catch (err) {
          console.error("Error assigning complaint:", err);
          ComplaintService.showNotification(
            "Failed to assign complaint. Please try again.",
            "danger"
          );
        } finally {
          btn.classList.remove("btn-loading");
          btn.disabled = false;
          technicianModal.hide();
        }
      }

      // Update status - saves to MongoDB
      async function updateStatus() {
        const newStatus = document.getElementById("newStatusSelect").value;
        const comments = document.getElementById("statusComments").value;
        const actorName = sessionStorage.getItem("userName") || "Officer Jane";

        try {
          // Update via API (saves to MongoDB)
          const result = await ApiService.updateComplaintStatus(
            currentComplaintId,
            newStatus,
            actorName,
            "officer",
            comments ||
              `Status updated to ${ComplaintService.getStatusLabel(newStatus)}`
          );

          if (result && result.success) {
            console.log("Status updated in MongoDB:", result);

            currentComplaint.status = newStatus;
            updateStatusBadge(newStatus);
            updateActionButtons();

            // Reload to get fresh timeline
            await loadComplaintData();

            updateStatusModal.hide();
            ComplaintService.showNotification(
              "Status updated in database successfully!",
              "success"
            );
          } else {
            throw new Error(result?.error || "Status update failed");
          }
        } catch (err) {
          console.error("Error updating status:", err);
          ComplaintService.showNotification(
            "Failed to update status. Please try again.",
            "danger"
          );
        }
      }

      // Reject complaint
      function rejectComplaint() {
        document.getElementById("rejectionReason").value = "";
        document.getElementById("rejectionNotes").value = "";
        rejectModal.show();
      }

      // Confirm rejection - saves to MongoDB
      async function confirmRejection() {
        const reason = document.getElementById("rejectionReason").value;
        const notes = document.getElementById("rejectionNotes").value;
        const actorName = sessionStorage.getItem("userName") || "Officer Jane";

        if (!reason) {
          ComplaintService.showNotification(
            "Please select a rejection reason.",
            "warning"
          );
          return;
        }

        try {
          // Update via API (saves to MongoDB)
          const result = await ApiService.updateComplaintStatus(
            currentComplaintId,
            "rejected",
            actorName,
            "officer",
            `Reason: ${reason}${notes ? " - " + notes : ""}`
          );

          if (result && result.success) {
            console.log("Rejection saved to MongoDB:", result);

            currentComplaint.status = "rejected";
            updateStatusBadge("rejected");
            updateActionButtons();

            // Reload to get fresh timeline
            await loadComplaintData();

            rejectModal.hide();
            ComplaintService.showNotification(
              "Complaint has been rejected and saved to database.",
              "warning"
            );
          } else {
            throw new Error(result?.error || "Rejection failed");
          }
        } catch (err) {
          console.error("Error rejecting complaint:", err);
          ComplaintService.showNotification(
            "Failed to reject complaint. Please try again.",
            "danger"
          );
        }
      }

      // Logout
      function logout() {
        sessionStorage.clear();
        window.location.href = "index.html";
      }
    </script>
    <!-- Vercel Web Analytics -->
    <script defer src="/_vercel/insights/script.js"></script>
  </body>
</html>
