<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Technician Dashboard - Officers Portal</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --primary-light: #e0e7ff;
        --success: #10b981;
        --success-light: #d1fae5;
        --warning: #f59e0b;
        --warning-light: #fef3c7;
        --danger: #ef4444;
        --danger-light: #fee2e2;
        --info: #06b6d4;
        --info-light: #cffafe;
        --dark: #1e293b;
        --gray-50: #f8fafc;
        --gray-100: #f1f5f9;
        --gray-200: #e2e8f0;
        --gray-300: #cbd5e1;
        --gray-400: #94a3b8;
        --gray-500: #64748b;
        --gray-600: #475569;
        --gray-700: #334155;
        --gray-800: #1e293b;
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --radius-xl: 24px;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
        --shadow-xl: 0 20px 60px rgba(0, 0, 0, 0.15);
      }

      * {
        font-family: "Plus Jakarta Sans", sans-serif;
      }

      body {
        background: linear-gradient(
          135deg,
          #f0f4ff 0%,
          #fef3f2 50%,
          #f0fdf4 100%
        );
        min-height: 100vh;
      }

      /* Navbar */
      .tech-navbar {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(30px);
        border-bottom: 1px solid rgba(226, 232, 240, 0.6);
        padding: 0.75rem 0;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
      }

      .tech-navbar .navbar-brand {
        font-weight: 700;
        font-size: 1.25rem;
        color: var(--dark);
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .tech-navbar .navbar-brand img {
        filter: drop-shadow(0 2px 8px rgba(99, 102, 241, 0.2));
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      }

      /* Availability Toggle */
      .availability-toggle {
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.05),
          rgba(59, 130, 246, 0.05)
        );
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        border: 1px solid rgba(99, 102, 241, 0.2);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .availability-toggle:hover {
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.1),
          rgba(59, 130, 246, 0.1)
        );
        border-color: rgba(99, 102, 241, 0.4);
      }
      .availability-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--dark);
      }
      .availability-switch {
        width: 3rem !important;
        height: 1.5rem !important;
        cursor: pointer;
      }
      .availability-switch:checked {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
      }
      .availability-switch:not(:checked) {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        border-color: #f59e0b;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
      }
      .availability-status {
        font-size: 0.6rem;
      }
      .availability-status .fa-circle {
        transition: color 0.3s ease;
        animation: statusPulse 2s infinite;
      }
      .availability-updating {
        opacity: 0.7;
        pointer-events: none;
      }

      @keyframes statusPulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
      }

      /* Main Content */
      .main-content {
        padding-top: 90px;
        padding-bottom: 40px;
      }

      /* Stats Cards - Enhanced */
      .stat-card {
        background: white;
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-100);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
      }

      .stat-card::after {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        width: 120px;
        height: 120px;
        border-radius: 50%;
        opacity: 0.05;
        z-index: 0;
      }

      .stat-card.active::before {
        background: linear-gradient(90deg, var(--warning) 0%, #d97706 100%);
      }
      .stat-card.active::after {
        background: var(--warning);
      }
      .stat-card.completed::before {
        background: linear-gradient(90deg, var(--success) 0%, #059669 100%);
      }
      .stat-card.completed::after {
        background: var(--success);
      }
      .stat-card.total::before {
        background: linear-gradient(
          90deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
      }
      .stat-card.total::after {
        background: var(--primary);
      }
      .stat-card.time::before {
        background: linear-gradient(90deg, var(--info) 0%, #0891b2 100%);
      }
      .stat-card.time::after {
        background: var(--info);
      }

      .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
      }

      .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        position: relative;
        z-index: 1;
      }

      .stat-card.active .stat-icon {
        background: linear-gradient(
          135deg,
          rgba(245, 158, 11, 0.15),
          rgba(245, 158, 11, 0.05)
        );
        color: var(--warning);
      }
      .stat-card.completed .stat-icon {
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.15),
          rgba(16, 185, 129, 0.05)
        );
        color: var(--success);
      }
      .stat-card.total .stat-icon {
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.15),
          rgba(99, 102, 241, 0.05)
        );
        color: var(--primary);
      }
      .stat-card.time .stat-icon {
        background: linear-gradient(
          135deg,
          rgba(6, 182, 212, 0.15),
          rgba(6, 182, 212, 0.05)
        );
        color: var(--info);
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--dark);
        line-height: 1;
        position: relative;
        z-index: 1;
      }

      .stat-label {
        color: var(--gray-500);
        font-size: 0.875rem;
        font-weight: 500;
        position: relative;
        z-index: 1;
      }

      /* Task Cards - Enhanced */
      .task-card {
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-100);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        position: relative;
      }

      .task-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--primary), var(--info));
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.3s ease;
      }

      .task-card:hover::before {
        transform: scaleX(1);
      }

      .task-card:hover {
        box-shadow: var(--shadow-xl);
        transform: translateY(-6px);
      }

      .task-card-header {
        padding: 1.5rem 1.5rem 1rem 1.5rem;
        border-bottom: 1px solid var(--gray-100);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }

      .task-id {
        font-weight: 700;
        color: var(--primary);
        font-size: 0.8rem;
        letter-spacing: 0.5px;
      }

      .task-priority {
        padding: 0.375rem 0.875rem;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .priority-high {
        background: linear-gradient(
          135deg,
          rgba(239, 68, 68, 0.15),
          rgba(239, 68, 68, 0.05)
        );
        color: var(--danger);
      }
      .priority-medium {
        background: linear-gradient(
          135deg,
          rgba(245, 158, 11, 0.15),
          rgba(245, 158, 11, 0.05)
        );
        color: var(--warning);
      }
      .priority-normal {
        background: linear-gradient(
          135deg,
          rgba(107, 114, 128, 0.15),
          rgba(107, 114, 128, 0.05)
        );
        color: var(--gray-500);
      }
      .priority-low {
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.15),
          rgba(16, 185, 129, 0.05)
        );
        color: var(--success);
      }

      .task-card-body {
        padding: 1.5rem;
      }

      .task-category {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.875rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
      }

      .category-water {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.15),
          rgba(59, 130, 246, 0.05)
        );
        color: #3b82f6;
      }
      .category-road {
        background: linear-gradient(
          135deg,
          rgba(245, 158, 11, 0.15),
          rgba(245, 158, 11, 0.05)
        );
        color: #f59e0b;
      }
      .category-waste {
        background: linear-gradient(
          135deg,
          rgba(34, 197, 94, 0.15),
          rgba(34, 197, 94, 0.05)
        );
        color: #22c55e;
      }
      .category-light {
        background: linear-gradient(
          135deg,
          rgba(234, 179, 8, 0.15),
          rgba(234, 179, 8, 0.05)
        );
        color: #eab308;
      }

      .task-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 0.5rem;
        letter-spacing: -0.3px;
      }

      .task-description {
        color: var(--gray-500);
        font-size: 0.875rem;
        line-height: 1.6;
        margin-bottom: 1rem;
      }

      .task-location {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--gray-600);
        font-size: 0.875rem;
        padding: 0.75rem 1rem;
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.05),
          rgba(59, 130, 246, 0.05)
        );
        border-radius: var(--radius-sm);
        margin-bottom: 1rem;
        border: 1px solid rgba(99, 102, 241, 0.1);
      }

      .task-location i {
        color: var(--danger);
        font-size: 1rem;
      }

      .task-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        font-size: 0.8125rem;
        color: var(--gray-500);
        padding-top: 1rem;
        border-top: 1px solid var(--gray-100);
      }

      .task-meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .task-meta-item i {
        color: var(--primary);
        opacity: 0.6;
      }

      .task-card-actions {
        padding: 1rem 1.5rem;
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.02),
          rgba(59, 130, 246, 0.02)
        );
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      /* Buttons - Enhanced */
      .btn-tech-primary {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        border: none;
        padding: 0.625rem 1.25rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
      }

      .btn-tech-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.35);
        color: white;
      }

      .btn-tech-primary:active {
        transform: translateY(0);
      }

      .btn-tech-success {
        background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        color: white;
        border: none;
        padding: 0.625rem 1.25rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
      }

      .btn-tech-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(16, 185, 129, 0.35);
        color: white;
      }

      .btn-tech-warning {
        background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        color: white;
        border: none;
        padding: 0.625rem 1.25rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.25);
      }

      .btn-tech-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(245, 158, 11, 0.35);
        color: white;
      }

      .btn-tech-outline {
        background: white;
        color: var(--gray-700);
        border: 1.5px solid var(--gray-300);
        padding: 0.625rem 1.25rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .btn-tech-outline:hover {
        background: linear-gradient(
          135deg,
          var(--primary-light) 0%,
          rgba(59, 130, 246, 0.1)
        );
        border-color: var(--primary);
        color: var(--primary);
      }

      /* Section Headers */
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
      }

      .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 1rem;
        letter-spacing: -0.5px;
      }

      .section-title i {
        font-size: 1.75rem;
        color: var(--primary);
      }

      .section-title .badge {
        font-size: 0.75rem;
        font-weight: 700;
        padding: 0.375rem 0.875rem;
        border-radius: 20px;
        background: linear-gradient(
          135deg,
          var(--primary-light),
          rgba(59, 130, 246, 0.1)
        );
        color: var(--primary);
      }

      /* Filter Pills */
      .filter-pills {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .filter-pill {
        padding: 0.5rem 1.125rem;
        border-radius: 24px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: white;
        color: var(--gray-600);
        border: 1.5px solid var(--gray-200);
      }

      .filter-pill:hover {
        background: var(--gray-50);
        border-color: var(--gray-300);
        transform: translateY(-2px);
      }

      .filter-pill.active {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      }

      /* Modal Styles - Enhanced */
      .modal-content {
        border-radius: var(--radius-xl);
        border: none;
        box-shadow: var(--shadow-xl);
        background: white;
      }

      .modal-header {
        border-bottom: 1px solid var(--gray-100);
        padding: 1.75rem 1.5rem;
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.02),
          rgba(59, 130, 246, 0.02)
        );
      }

      .modal-title {
        font-weight: 700;
        color: var(--dark);
        font-size: 1.25rem;
      }

      .modal-body {
        padding: 1.75rem 1.5rem;
      }

      .modal-footer {
        border-top: 1px solid var(--gray-100);
        padding: 1.25rem 1.5rem;
        background: var(--gray-50);
      }

      .form-label {
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.75rem;
        font-size: 0.95rem;
      }

      .form-control,
      .form-select {
        border-radius: var(--radius-md);
        border: 1.5px solid var(--gray-200);
        padding: 0.75rem 1rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 0.95rem;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
      }

      /* Photo Upload - Enhanced */
      .photo-upload-area {
        border: 2px dashed var(--primary);
        border-radius: var(--radius-lg);
        padding: 2.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.05),
          rgba(59, 130, 246, 0.05)
        );
      }

      .photo-upload-area:hover {
        border-color: var(--primary);
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.1),
          rgba(59, 130, 246, 0.1)
        );
        transform: translateY(-2px);
      }

      .photo-upload-area i {
        font-size: 2.5rem;
        color: var(--primary);
        margin-bottom: 0.75rem;
      }

      .photo-preview {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 1.5rem;
      }

      .photo-preview-item {
        position: relative;
        width: 100px;
        height: 100px;
        border-radius: var(--radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-md);
      }

      .photo-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .photo-preview-item .remove-photo {
        position: absolute;
        top: 6px;
        right: 6px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        color: white;
        border: 2px solid white;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .photo-preview-item .remove-photo:hover {
        transform: scale(1.1);
      }

      /* Timeline in Modal */
      .task-timeline {
        max-height: 350px;
        overflow-y: auto;
        padding-right: 0.75rem;
      }

      .timeline-item {
        display: flex;
        gap: 1rem;
        padding: 1.25rem 0;
        border-bottom: 1px solid var(--gray-100);
      }

      .timeline-item:last-child {
        border-bottom: none;
      }

      .timeline-marker {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 1rem;
      }

      .timeline-content {
        flex: 1;
        padding-top: 0.25rem;
      }

      .timeline-date {
        font-size: 0.75rem;
        color: var(--gray-400);
        margin-bottom: 0.375rem;
        font-weight: 500;
      }

      .timeline-title {
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 0.375rem;
        font-size: 0.95rem;
      }

      .timeline-description {
        font-size: 0.875rem;
        color: var(--gray-500);
        line-height: 1.5;
      }

      /* Empty State - Enhanced */
      .empty-state {
        text-align: center;
        padding: 5rem 2rem;
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
      }

      .empty-state i {
        font-size: 4.5rem;
        background: linear-gradient(135deg, var(--gray-200), var(--gray-300));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 1.5rem;
      }

      .empty-state h5 {
        font-weight: 700;
        color: var(--gray-700);
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
      }

      .empty-state p {
        color: var(--gray-400);
        font-size: 0.95rem;
      }

      /* Animations - Enhanced */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideInLeft {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes scaleIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .fade-in-up {
        animation: fadeInUp 0.5s ease forwards;
      }

      .task-card {
        animation: fadeInUp 0.5s ease forwards;
      }

      .stat-card {
        animation: fadeInUp 0.5s ease forwards;
      }

      /* Task Status Badge - Enhanced */
      .task-status {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-in-progress {
        background: linear-gradient(
          135deg,
          rgba(245, 158, 11, 0.15),
          rgba(245, 158, 11, 0.05)
        );
        color: var(--warning);
      }

      .status-resolved {
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.15),
          rgba(16, 185, 129, 0.05)
        );
        color: var(--success);
      }

      .status-new {
        background: linear-gradient(
          135deg,
          rgba(239, 68, 68, 0.15),
          rgba(239, 68, 68, 0.05)
        );
        color: var(--danger);
      }

      .status-assigned {
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.15),
          rgba(99, 102, 241, 0.05)
        );
        color: var(--primary);
      }

      .status-completed {
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.2),
          rgba(16, 185, 129, 0.1)
        );
        color: #059669;
        font-weight: 700;
      }

      .status-rejected {
        background: linear-gradient(
          135deg,
          rgba(107, 114, 128, 0.15),
          rgba(107, 114, 128, 0.05)
        );
        color: #6b7280;
      }

      .status-closed {
        background: linear-gradient(
          135deg,
          rgba(31, 41, 55, 0.15),
          rgba(31, 41, 55, 0.05)
        );
        color: #374151;
      }

      /* Loading Spinner */
      .btn-loading {
        position: relative;
        pointer-events: none;
      }

      .btn-loading::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        right: 12px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* New task highlight */
      .task-card.new-highlight {
        animation: highlightPulse 2s ease;
      }

      @keyframes highlightPulse {
        0%,
        100% {
          box-shadow: var(--shadow-md);
        }
        50% {
          box-shadow: 0 0 0 6px rgba(99, 102, 241, 0.25), var(--shadow-lg);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .section-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 1rem;
        }

        .filter-pills {
          width: 100%;
          overflow-x: auto;
          flex-wrap: nowrap;
          padding-bottom: 0.5rem;
        }

        .stat-value {
          font-size: 1.75rem;
        }

        .section-title {
          font-size: 1.25rem;
        }
      }

      /* Profile Drawer Styles */
      .profile-drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1040;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .profile-drawer-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .profile-drawer {
        position: fixed;
        top: 0;
        right: 0;
        width: 420px;
        max-width: 100%;
        height: 100%;
        background: white;
        z-index: 1050;
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: -10px 0 30px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
      }

      .profile-drawer.active {
        transform: translateX(0);
      }

      .drawer-header {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        padding: 1.5rem;
        position: relative;
      }

      .drawer-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .drawer-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .drawer-avatar-large {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: 600;
        color: white;
        margin-bottom: 1rem;
        border: 3px solid rgba(255, 255, 255, 0.3);
      }

      .drawer-body {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
      }

      .drawer-section-title {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--gray-500);
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--gray-200);
      }

      .drawer-form-group {
        margin-bottom: 1.5rem;
      }

      .drawer-form-group label {
        display: block;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.75rem;
        font-size: 0.95rem;
      }

      .drawer-form-group label i {
        width: 24px;
        color: var(--primary);
        margin-right: 0.75rem;
      }

      .drawer-form-group input {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 1.5px solid var(--gray-200);
        border-radius: var(--radius-md);
        font-size: 1rem;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }

      .drawer-form-group input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
      }

      .drawer-form-group input.is-invalid {
        border-color: var(--danger);
      }

      .drawer-form-group input:disabled {
        background: var(--gray-50);
        color: var(--gray-500);
        cursor: not-allowed;
      }

      .drawer-form-group .invalid-feedback {
        color: var(--danger);
        font-size: 0.8rem;
        margin-top: 0.375rem;
        display: none;
      }

      .drawer-form-group input.is-invalid + .invalid-feedback {
        display: block;
      }

      .password-toggle {
        position: relative;
      }

      .password-toggle input {
        padding-right: 45px;
      }

      .password-toggle button {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--gray-500);
        cursor: pointer;
        padding: 5px;
        transition: color 0.2s ease;
      }

      .password-toggle button:hover {
        color: var(--primary);
      }

      .drawer-footer {
        padding: 1.25rem 1.5rem;
        background: var(--gray-50);
        border-top: 1px solid var(--gray-200);
        display: flex;
        gap: 1rem;
      }

      .drawer-footer .btn {
        flex: 1;
        padding: 0.875rem 1rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-drawer-save {
        background: linear-gradient(
          135deg,
          var(--primary) 0%,
          var(--primary-dark) 100%
        );
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
      }

      .btn-drawer-save:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.35);
      }

      .btn-drawer-save:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-drawer-cancel {
        background: white;
        color: var(--gray-600);
        border: 1.5px solid var(--gray-300);
      }

      .btn-drawer-cancel:hover {
        background: linear-gradient(
          135deg,
          var(--primary-light),
          rgba(59, 130, 246, 0.1)
        );
        border-color: var(--primary);
        color: var(--primary);
      }

      .user-clickable {
        cursor: pointer;
        transition: opacity 0.2s ease;
      }

      .user-clickable:hover {
        opacity: 0.8;
      }

      .btn-drawer-save .spinner-border {
        width: 1rem;
        height: 1rem;
        margin-right: 0.5rem;
      }

      .profile-toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        color: white;
        padding: 1.25rem 1.75rem;
        border-radius: var(--radius-md);
        z-index: 1060;
        transform: translateY(100px);
        opacity: 0;
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          opacity 0.4s ease;
        box-shadow: var(--shadow-lg);
      }

      .profile-toast {
        background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      }

      .profile-toast.show {
        transform: translateY(0);
        opacity: 1;
      }

      .profile-toast.error {
        background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
      }

      @media (max-width: 576px) {
        .profile-drawer {
          width: 100%;
        }

        .drawer-header {
          padding: 1.5rem;
        }

        .drawer-avatar-large {
          width: 70px;
          height: 70px;
          font-size: 1.75rem;
        }

        .drawer-body {
          padding: 1.25rem;
        }

        .drawer-footer {
          padding: 1rem;
          flex-direction: column;
        }

        .drawer-footer .btn {
          width: 100%;
        }
      }

      /* Beautiful Notification Icon Styles - Enhanced */
      .notification-btn {
        position: relative;
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1.5px solid rgba(148, 163, 184, 0.3);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      }

      .notification-btn:hover {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15);
        border-color: rgba(99, 102, 241, 0.4);
      }

      .notification-btn .fa-bell {
        font-size: 1.25rem;
        color: #475569;
        transition: all 0.3s ease;
      }

      .notification-btn:hover .fa-bell {
        color: var(--primary);
        animation: bellRing 0.5s ease;
      }

      @keyframes bellRing {
        0%,
        100% {
          transform: rotate(0);
        }
        20% {
          transform: rotate(15deg);
        }
        40% {
          transform: rotate(-15deg);
        }
        60% {
          transform: rotate(10deg);
        }
        80% {
          transform: rotate(-10deg);
        }
      }

      .notification-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        min-width: 22px;
        height: 22px;
        padding: 0 7px;
        font-size: 0.65rem;
        font-weight: 800;
        color: white;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border-radius: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
        box-shadow: 0 2px 10px rgba(239, 68, 68, 0.4);
        animation: badgePulse 2s infinite;
      }

      .notification-badge.hidden {
        display: none;
      }

      @keyframes badgePulse {
        0%,
        100% {
          box-shadow: 0 2px 10px rgba(239, 68, 68, 0.4);
        }
        50% {
          box-shadow: 0 2px 20px rgba(239, 68, 68, 0.6);
        }
      }

      .notification-dropdown {
        min-width: 380px;
        max-width: 420px;
        border-radius: 16px;
        border: none;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        padding: 0;
        overflow: hidden;
        animation: dropdownSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @keyframes dropdownSlide {
        from {
          opacity: 0;
          transform: translateY(-15px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .notification-header {
        background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
        color: white;
        padding: 1.25rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .notification-header h6 {
        margin: 0;
        font-weight: 700;
        font-size: 1.05rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .notification-header .clear-btn {
        background: rgba(255, 255, 255, 0.15);
        border: none;
        color: white;
        padding: 7px 14px;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .notification-header .clear-btn:hover {
        background: rgba(255, 255, 255, 0.25);
      }

      .notification-body {
        max-height: 380px;
        overflow-y: auto;
        padding: 0.75rem;
      }

      .notification-item {
        display: flex;
        align-items: flex-start;
        gap: 14px;
        padding: 14px;
        border-radius: 12px;
        margin-bottom: 6px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        background: white;
      }

      .notification-item:hover {
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.05),
          rgba(59, 130, 246, 0.05)
        );
        transform: translateX(4px);
      }

      .notification-icon-wrapper {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 1.25rem;
      }

      .notification-icon-wrapper.danger {
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        color: #ef4444;
      }

      .notification-icon-wrapper.success {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        color: #10b981;
      }

      .notification-icon-wrapper.info {
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        color: #3b82f6;
      }

      .notification-icon-wrapper.warning {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        color: #f59e0b;
      }

      .notification-content {
        flex: 1;
        min-width: 0;
      }

      .notification-content .message {
        font-size: 0.9rem;
        color: #1e293b;
        font-weight: 600;
        line-height: 1.5;
        margin-bottom: 6px;
      }

      .notification-content .time {
        font-size: 0.75rem;
        color: #94a3b8;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .notification-empty {
        text-align: center;
        padding: 3rem 1.5rem;
        color: #94a3b8;
      }

      .notification-empty i {
        font-size: 2.75rem;
        margin-bottom: 1.25rem;
        opacity: 0.4;
      }

      .notification-empty p {
        margin: 0;
        font-size: 0.95rem;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top tech-navbar">
      <div class="container-fluid px-4">
        <a
          class="navbar-brand d-flex align-items-center"
          href="technician-dashboard.html"
        >
          <img
            src="images/govt.png"
            alt="Logo"
            width="36"
            height="36"
            class="me-2"
          />
          <span>Technician Portal</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#techNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="techNav">
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item">
              <a class="nav-link active" href="technician-dashboard.html">
                <i class="fas fa-clipboard-list me-1"></i> My Tasks
              </a>
            </li>
            <!-- Availability Toggle -->
            <li class="nav-item ms-lg-2">
              <div
                class="availability-toggle d-flex align-items-center"
                title="Toggle your availability status"
              >
                <span
                  class="availability-label me-2 d-none d-md-inline"
                  id="availabilityLabel"
                  >Available</span
                >
                <div class="form-check form-switch mb-0">
                  <input
                    class="form-check-input availability-switch"
                    type="checkbox"
                    id="availabilitySwitch"
                    checked
                    onchange="toggleAvailability()"
                  />
                </div>
                <span class="availability-status ms-1" id="availabilityStatus">
                  <i
                    class="fas fa-circle text-success"
                    id="availabilityIcon"
                  ></i>
                </span>
              </div>
            </li>
            <!-- Notifications Dropdown -->
            <li class="nav-item dropdown ms-lg-2">
              <a
                class="nav-link p-0 notification-btn"
                href="#"
                data-bs-toggle="dropdown"
                id="notificationToggle"
              >
                <i class="fas fa-bell"></i>
                <span class="notification-badge hidden" id="notificationBadge"
                  >0</span
                >
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end notification-dropdown"
                id="notificationDropdown"
              >
                <li class="notification-header">
                  <h6><i class="fas fa-bell"></i> Notifications</h6>
                  <button class="clear-btn" onclick="clearNotifications()">
                    <i class="fas fa-trash-alt me-1"></i>Clear all
                  </button>
                </li>
                <li class="notification-body" id="notificationBody">
                  <div class="notification-empty" id="noNotifications">
                    <i class="fas fa-bell-slash"></i>
                    <p>No new notifications</p>
                  </div>
                </li>
              </ul>
            </li>
            <li class="nav-item ms-lg-3">
              <div
                class="d-flex align-items-center user-clickable"
                onclick="openProfileDrawer()"
                title="Click to edit profile"
              >
                <div class="user-avatar me-2" id="userAvatar">FR</div>
                <div class="d-none d-lg-block">
                  <div class="fw-bold small" id="userName">Fazlur Rahman</div>
                  <div class="text-muted small" id="techId">TECH-003</div>
                </div>
                <i
                  class="fas fa-chevron-right ms-2 d-none d-lg-inline text-muted"
                  style="font-size: 0.7rem"
                ></i>
              </div>
            </li>
            <li class="nav-item ms-3">
              <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
              </button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
      <div class="container-fluid px-4">
        <!-- Stats Row -->
        <div class="row g-4 mb-4">
          <div class="col-6 col-lg-3">
            <div class="stat-card active">
              <div class="d-flex align-items-center gap-3">
                <div class="stat-icon">
                  <i class="fas fa-clock"></i>
                </div>
                <div>
                  <div class="stat-value" id="activeTasks">0</div>
                  <div class="stat-label">Active Tasks</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <div class="stat-card completed">
              <div class="d-flex align-items-center gap-3">
                <div class="stat-icon">
                  <i class="fas fa-check-double"></i>
                </div>
                <div>
                  <div class="stat-value" id="completedTasks">0</div>
                  <div class="stat-label">Completed</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <div class="stat-card total">
              <div class="d-flex align-items-center gap-3">
                <div class="stat-icon">
                  <i class="fas fa-tasks"></i>
                </div>
                <div>
                  <div class="stat-value" id="totalTasks">0</div>
                  <div class="stat-label">Total Tasks</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <div class="stat-card time">
              <div class="d-flex align-items-center gap-3">
                <div class="stat-icon">
                  <i class="fas fa-clock"></i>
                </div>
                <div>
                  <div class="stat-value" id="totalTime">0h</div>
                  <div class="stat-label">Time Spent</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Filter Section -->
        <div class="section-header">
          <h5 class="section-title">
            <i class="fas fa-clipboard-list text-primary"></i>
            My Assigned Tasks
            <span class="badge bg-primary" id="taskCount">0</span>
          </h5>
          <div class="filter-pills">
            <span class="filter-pill active" data-filter="all">All Tasks</span>
            <span class="filter-pill" data-filter="assigned">Assigned</span>
            <span class="filter-pill" data-filter="in-progress"
              >In Progress</span
            >
            <span class="filter-pill" data-filter="completed">Complete</span>
          </div>
        </div>

        <!-- Tasks Grid -->
        <div class="row g-4" id="tasksContainer">
          <!-- Tasks will be loaded here dynamically -->
        </div>

        <!-- Empty State -->
        <div class="empty-state d-none" id="emptyState">
          <i class="fas fa-clipboard-check"></i>
          <h5>No tasks assigned</h5>
          <p>You don't have any tasks assigned yet. Check back later!</p>
        </div>
      </div>
    </div>

    <!-- Task Detail Modal -->
    <div class="modal fade" id="taskDetailModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <div>
              <h5 class="modal-title mb-1" id="modalTaskId">CMPT-128</h5>
              <span class="task-category category-light" id="modalCategory">
                <i class="fas fa-lightbulb"></i> Street Lighting
              </span>
            </div>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-lg-7">
                <h6 class="fw-bold mb-2">Issue Description</h6>
                <p class="text-muted mb-3" id="modalDescription">
                  Multiple street lights not working on the road.
                </p>

                <div class="task-location mb-4">
                  <i class="fas fa-map-marker-alt"></i>
                  <span id="modalLocation">Uttara Sector-7, Dhaka</span>
                </div>

                <div class="row g-3 mb-4">
                  <div class="col-6">
                    <div class="p-3 bg-light rounded-3">
                      <div class="small text-muted mb-1">Status</div>
                      <span
                        class="task-status status-in-progress"
                        id="modalStatus"
                        >In Progress</span
                      >
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="p-3 bg-light rounded-3">
                      <div class="small text-muted mb-1">Priority</div>
                      <span
                        class="task-priority priority-medium"
                        id="modalPriority"
                        >Medium</span
                      >
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="p-3 bg-light rounded-3">
                      <div class="small text-muted mb-1">Assigned On</div>
                      <div class="fw-medium" id="modalAssignedDate">
                        Aug 21, 2025
                      </div>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="p-3 bg-light rounded-3">
                      <div class="small text-muted mb-1">Time Spent</div>
                      <div class="fw-medium" id="modalTimeSpent">0 hours</div>
                    </div>
                  </div>
                </div>

                <h6 class="fw-bold mb-3">Citizen Information</h6>
                <div
                  class="d-flex align-items-center gap-3 p-3 bg-light rounded-3 mb-4"
                >
                  <div class="user-avatar" id="modalCitizenAvatar">JD</div>
                  <div>
                    <div class="fw-bold" id="modalCitizenName">John Doe</div>
                    <div class="small text-muted" id="modalCitizenPhone">
                      +880 1700 000000
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-lg-5">
                <h6 class="fw-bold mb-3">Status Timeline</h6>
                <div class="task-timeline" id="modalTimeline">
                  <!-- Timeline items will be loaded here -->
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer justify-content-between">
            <button
              type="button"
              class="btn-tech-outline"
              data-bs-dismiss="modal"
            >
              <i class="fas fa-times"></i> Close
            </button>
            <div class="d-flex gap-2" id="modalActions">
              <button
                type="button"
                class="btn-tech-warning"
                onclick="openProgressModal()"
              >
                <i class="fas fa-edit"></i> Post Update
              </button>
              <button
                type="button"
                class="btn-tech-success"
                onclick="openCompleteModal()"
              >
                <i class="fas fa-check"></i> Mark Complete
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Progress Update Modal -->
    <div class="modal fade" id="progressModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-edit text-warning me-2"></i>
              Post Progress Update
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="progressForm">
              <div class="mb-3">
                <label class="form-label"
                  >Work Notes <span class="text-danger">*</span></label
                >
                <textarea
                  class="form-control"
                  id="progressNotes"
                  rows="4"
                  placeholder="Describe the work done, materials used, issues encountered..."
                ></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">Time Spent (hours)</label>
                <input
                  type="number"
                  class="form-control"
                  id="progressTime"
                  step="0.5"
                  min="0"
                  placeholder="e.g., 2.5"
                />
              </div>

              <div class="mb-3">
                <label class="form-label">Attach Photos</label>
                <div
                  class="photo-upload-area"
                  onclick="document.getElementById('progressPhotos').click()"
                >
                  <i class="fas fa-camera d-block"></i>
                  <span class="text-muted">Click to upload photos</span>
                  <input
                    type="file"
                    id="progressPhotos"
                    class="d-none"
                    accept="image/*"
                    multiple
                    onchange="handlePhotoUpload(this, 'progressPreview')"
                  />
                </div>
                <div class="photo-preview" id="progressPreview"></div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn-tech-outline"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn-tech-primary"
              id="submitProgressBtn"
              onclick="submitProgressUpdate()"
            >
              <i class="fas fa-paper-plane"></i> Post Update
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Complete Task Modal -->
    <div class="modal fade" id="completeModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-check-circle text-success me-2"></i>
              Mark Task as Complete
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info d-flex align-items-start gap-2 mb-4">
              <i class="fas fa-info-circle mt-1"></i>
              <div>
                <strong>Important:</strong> Once marked complete, this task will
                be moved to resolved status and the citizen will be notified.
              </div>
            </div>

            <form id="completeForm">
              <div class="mb-3">
                <label class="form-label"
                  >Completion Notes <span class="text-danger">*</span></label
                >
                <textarea
                  class="form-control"
                  id="completeNotes"
                  rows="4"
                  placeholder="Describe the resolution, what was fixed, final remarks..."
                ></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">Final Time Spent (hours)</label>
                <input
                  type="number"
                  class="form-control"
                  id="completeTime"
                  step="0.5"
                  min="0"
                  placeholder="Additional time for completion"
                />
              </div>

              <div class="mb-3">
                <label class="form-label">Completion Photos</label>
                <div
                  class="photo-upload-area"
                  onclick="document.getElementById('completePhotos').click()"
                >
                  <i class="fas fa-camera d-block"></i>
                  <span class="text-muted">Click to upload final photos</span>
                  <input
                    type="file"
                    id="completePhotos"
                    class="d-none"
                    accept="image/*"
                    multiple
                    onchange="handlePhotoUpload(this, 'completePreview')"
                  />
                </div>
                <div class="photo-preview" id="completePreview"></div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn-tech-outline"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn-tech-success"
              id="submitCompleteBtn"
              onclick="submitCompletion()"
            >
              <i class="fas fa-check-double"></i> Mark as Complete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Start Work Modal -->
    <div class="modal fade" id="startWorkModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-play-circle text-warning me-2"></i>
              Start Working on Task
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body text-center py-4">
            <div class="mb-4">
              <i class="fas fa-tools fa-3x text-warning mb-3"></i>
              <h5>Ready to start working?</h5>
              <p class="text-muted">
                This will update the task status to "In Progress" and notify the
                citizen.
              </p>
            </div>
            <div class="bg-light rounded-3 p-3">
              <div class="small text-muted">Task ID</div>
              <div class="fw-bold" id="startWorkTaskId">CMPT-128</div>
            </div>
          </div>
          <div class="modal-footer justify-content-center">
            <button
              type="button"
              class="btn-tech-outline"
              data-bs-dismiss="modal"
            >
              Not Now
            </button>
            <button
              type="button"
              class="btn-tech-warning"
              id="confirmStartBtn"
              onclick="confirmStartWork()"
            >
              <i class="fas fa-play"></i> Start Work
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Drawer Overlay -->
    <div
      class="profile-drawer-overlay"
      id="profileDrawerOverlay"
      onclick="closeProfileDrawer()"
    ></div>

    <!-- Profile Drawer -->
    <div class="profile-drawer" id="profileDrawer">
      <div class="drawer-header">
        <button
          class="drawer-close"
          onclick="closeProfileDrawer()"
          aria-label="Close"
        >
          <i class="fas fa-times"></i>
        </button>
        <div class="drawer-avatar-large" id="drawerAvatar">FR</div>
        <h5 class="mb-1" id="drawerName">Fazlur Rahman</h5>
        <p class="mb-0 opacity-75" style="font-size: 0.9rem">
          <i class="fas fa-hard-hat me-1"></i>Technician Account
        </p>
      </div>

      <div class="drawer-body">
        <form id="profileForm" novalidate>
          <!-- Personal Information -->
          <h6 class="drawer-section-title">
            <i class="fas fa-user me-2"></i>Personal Information
          </h6>

          <div class="drawer-form-group">
            <label for="profileName">
              <i class="fas fa-id-card"></i>Full Name
            </label>
            <input
              type="text"
              id="profileName"
              name="name"
              placeholder="Enter your full name"
              required
              minlength="2"
              maxlength="50"
            />
            <div class="invalid-feedback">
              Please enter a valid name (2-50 characters)
            </div>
          </div>

          <div class="drawer-form-group">
            <label for="profileEmail">
              <i class="fas fa-envelope"></i>Email Address
            </label>
            <input
              type="email"
              id="profileEmail"
              name="email"
              placeholder="Enter your email"
              disabled
              title="Email cannot be changed"
            />
            <small class="text-muted"
              ><i class="fas fa-lock me-1"></i>Email cannot be changed</small
            >
          </div>

          <!-- Contact Information -->
          <h6 class="drawer-section-title mt-4">
            <i class="fas fa-phone me-2"></i>Contact Information
          </h6>

          <div class="drawer-form-group">
            <label for="profilePhone">
              <i class="fas fa-mobile-alt"></i>Phone Number
            </label>
            <input
              type="tel"
              id="profilePhone"
              name="phone"
              placeholder="Enter your phone number"
              pattern="[\+]?[0-9\s\-]{10,15}"
            />
            <div class="invalid-feedback">
              Please enter a valid phone number
            </div>
          </div>

          <!-- Technician Information -->
          <h6 class="drawer-section-title mt-4">
            <i class="fas fa-tools me-2"></i>Technician Information
          </h6>

          <div class="drawer-form-group">
            <label for="profileTechId">
              <i class="fas fa-id-badge"></i>Technician ID
            </label>
            <input
              type="text"
              id="profileTechId"
              name="technicianId"
              disabled
            />
          </div>

          <div class="drawer-form-group">
            <label for="profileDepartment">
              <i class="fas fa-briefcase"></i>Department
            </label>
            <input
              type="text"
              id="profileDepartment"
              name="department"
              placeholder="Enter your department"
            />
          </div>

          <div class="drawer-form-group">
            <label for="profileSpecialty">
              <i class="fas fa-certificate"></i>Specialty
            </label>
            <input
              type="text"
              id="profileSpecialty"
              name="specialty"
              placeholder="Enter your specialty"
            />
          </div>

          <!-- Security -->
          <h6 class="drawer-section-title mt-4">
            <i class="fas fa-shield-alt me-2"></i>Security
          </h6>

          <div class="drawer-form-group">
            <label for="profileCurrentPassword">
              <i class="fas fa-key"></i>Current Password
            </label>
            <div class="password-toggle">
              <input
                type="password"
                id="profileCurrentPassword"
                name="currentPassword"
                placeholder="Enter current password"
                autocomplete="current-password"
              />
              <button
                type="button"
                onclick="togglePassword('profileCurrentPassword')"
                aria-label="Toggle password visibility"
              >
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <div class="invalid-feedback">Current password is incorrect</div>
          </div>

          <div class="drawer-form-group">
            <label for="profileNewPassword">
              <i class="fas fa-lock"></i>New Password
            </label>
            <div class="password-toggle">
              <input
                type="password"
                id="profileNewPassword"
                name="newPassword"
                placeholder="Enter new password (leave blank to keep current)"
                minlength="6"
                autocomplete="new-password"
              />
              <button
                type="button"
                onclick="togglePassword('profileNewPassword')"
                aria-label="Toggle password visibility"
              >
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <div class="invalid-feedback">
              Password must be at least 6 characters
            </div>
          </div>

          <div class="drawer-form-group">
            <label for="profileConfirmPassword">
              <i class="fas fa-lock"></i>Confirm New Password
            </label>
            <div class="password-toggle">
              <input
                type="password"
                id="profileConfirmPassword"
                name="confirmPassword"
                placeholder="Confirm new password"
                autocomplete="new-password"
              />
              <button
                type="button"
                onclick="togglePassword('profileConfirmPassword')"
                aria-label="Toggle password visibility"
              >
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <div class="invalid-feedback">Passwords do not match</div>
          </div>

          <!-- Account Info -->
          <h6 class="drawer-section-title mt-4">
            <i class="fas fa-info-circle me-2"></i>Account Information
          </h6>

          <div class="drawer-form-group">
            <label for="profileUserId">
              <i class="fas fa-hashtag"></i>User ID
            </label>
            <input type="text" id="profileUserId" name="userId" disabled />
          </div>

          <div class="drawer-form-group">
            <label for="profileCreatedAt">
              <i class="fas fa-calendar-plus"></i>Member Since
            </label>
            <input
              type="text"
              id="profileCreatedAt"
              name="createdAt"
              disabled
            />
          </div>
        </form>
      </div>

      <div class="drawer-footer">
        <button
          type="button"
          class="btn btn-drawer-cancel"
          onclick="closeProfileDrawer()"
        >
          <i class="fas fa-times me-1"></i>Cancel
        </button>
        <button
          type="button"
          class="btn btn-drawer-save"
          onclick="saveProfile()"
          id="saveProfileBtn"
        >
          <i class="fas fa-save me-1"></i>Save Changes
        </button>
      </div>
    </div>

    <!-- Profile Toast Notification -->
    <div class="profile-toast" id="profileToast">
      <i class="fas fa-check-circle me-2"></i>
      <span id="profileToastMessage">Profile updated successfully!</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="user-service.js"></script>
    <script src="complaint-service.js"></script>
    <!-- API Service for MongoDB -->
    <script src="api-service.js"></script>
    <script>
      // ============================================
      // TECHNICIAN STATE
      // ============================================
      const technicianState = {
        id: "TECH-003",
        name: "Fazlur Rahman",
        initials: "FR",
        currentFilter: "all",
        selectedTask: null,
        uploadedPhotos: [],
        isAvailable: true,
      };

      // Notification state
      let notifications = [];
      let notificationCount = 0;
      let processedNotificationKeys = new Set();
      const NOTIFICATIONS_STORAGE_KEY = "technician_notifications"; // localStorage key

      // Modal instances
      let taskDetailModal, progressModal, completeModal, startWorkModal;

      // ============================================
      // INITIALIZATION
      // ============================================
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize modals
        taskDetailModal = new bootstrap.Modal(
          document.getElementById("taskDetailModal")
        );
        progressModal = new bootstrap.Modal(
          document.getElementById("progressModal")
        );
        completeModal = new bootstrap.Modal(
          document.getElementById("completeModal")
        );
        startWorkModal = new bootstrap.Modal(
          document.getElementById("startWorkModal")
        );

        // Load technician info from session
        loadTechnicianInfo();

        // Load tasks
        loadTasks();

        // Setup filter pills
        setupFilterPills();

        // Load existing notifications from server
        loadNotifications();

        // Subscribe to real-time updates (API only to avoid duplicates)
        if (ApiService.subscribe) {
          ApiService.subscribe(handleRealTimeUpdate);
        }

        console.log("Technician Dashboard initialized");
      });

      function loadTechnicianInfo() {
        const storedId = sessionStorage.getItem("technicianId");
        const storedName = sessionStorage.getItem("userName");

        if (storedId) technicianState.id = storedId;
        if (storedName) {
          technicianState.name = storedName;
          technicianState.initials = ComplaintService.getInitials(storedName);
        }

        document.getElementById("userName").textContent = technicianState.name;
        document.getElementById("techId").textContent = technicianState.id;
        document.getElementById("userAvatar").textContent =
          technicianState.initials;

        // Load availability status from database
        loadAvailabilityStatus();
      }

      // ============================================
      // AVAILABILITY TOGGLE
      // ============================================
      async function loadAvailabilityStatus() {
        const userId = sessionStorage.getItem("userId");
        if (!userId) return;

        try {
          const user = await ApiService.getUserById(userId);
          if (user) {
            const isAvailable = user.status === "active";
            updateAvailabilityUI(isAvailable);
            technicianState.isAvailable = isAvailable;
          }
        } catch (err) {
          console.error("Error loading availability status:", err);
        }
      }

      async function toggleAvailability() {
        const toggle = document.getElementById("availabilitySwitch");
        const toggleContainer = document.querySelector(".availability-toggle");
        const userId = sessionStorage.getItem("userId");

        if (!userId) {
          ComplaintService.showNotification(
            "User ID not found. Please log in again.",
            "danger"
          );
          toggle.checked = !toggle.checked; // Revert
          return;
        }

        const isAvailable = toggle.checked;
        const newStatus = isAvailable ? "active" : "inactive";

        // Show updating state
        toggleContainer.classList.add("availability-updating");

        try {
          // Update in MongoDB immediately
          const result = await ApiService.updateUser(userId, {
            status: newStatus,
          });

          if (result) {
            console.log("Availability updated in MongoDB:", newStatus);
            technicianState.isAvailable = isAvailable;
            updateAvailabilityUI(isAvailable);

            ComplaintService.showNotification(
              isAvailable
                ? " You are now Available for tasks"
                : " You are now marked as Offline",
              isAvailable ? "success" : "danger"
            );
          } else {
            throw new Error("Failed to update availability");
          }
        } catch (err) {
          console.error("Error updating availability:", err);
          // Revert toggle on error
          toggle.checked = !isAvailable;
          ComplaintService.showNotification(
            "Failed to update availability. Please try again.",
            "danger"
          );
        } finally {
          toggleContainer.classList.remove("availability-updating");
        }
      }

      function updateAvailabilityUI(isAvailable) {
        const toggle = document.getElementById("availabilitySwitch");
        const label = document.getElementById("availabilityLabel");
        const icon = document.getElementById("availabilityIcon");

        toggle.checked = isAvailable;
        label.textContent = isAvailable ? "Available" : "Offline";
        icon.className = isAvailable
          ? "fas fa-circle text-success"
          : "fas fa-circle text-danger";
      }

      // ============================================
      // LOAD AND RENDER TASKS
      // ============================================
      async function loadTasks() {
        try {
          // Load tasks from MongoDB
          const apiTasks = await ApiService.getComplaintsByTechnician(
            technicianState.id
          );
          console.log("Tasks from MongoDB:", apiTasks);

          let tasks = [];
          if (apiTasks && Array.isArray(apiTasks) && apiTasks.length > 0) {
            tasks = apiTasks.map((t) => ({
              id: t.complaintId || t._id || t.id,
              category: t.category,
              categoryLabel: t.categoryLabel || t.category,
              description: t.description,
              location: t.location,
              status: t.status,
              priority: t.priority,
              citizen: t.citizen,
              assignedTo: t.assignedTo,
              timeline: t.timeline,
              progressUpdates: t.progressUpdates,
              totalTimeSpent: t.totalTimeSpent || 0,
              createdAt: t.createdAt,
              updatedAt: t.updatedAt,
            }));
          } else {
            // Fallback to localStorage
            tasks = ComplaintService.getTasksForTechnician(technicianState.id);
          }

          updateStats(tasks);
          renderTasks(tasks);
        } catch (err) {
          console.error("Error loading tasks:", err);
          // Fallback to localStorage
          const tasks = ComplaintService.getTasksForTechnician(
            technicianState.id
          );
          updateStats(tasks);
          renderTasks(tasks);
        }
      }

      function updateStats(tasks) {
        const active = tasks.filter((t) => t.status === "in-progress").length;
        const completed = tasks.filter(
          (t) => t.status === "resolved" || t.status === "completed"
        ).length;
        const totalTime = tasks.reduce(
          (sum, t) => sum + (t.totalTimeSpent || 0),
          0
        );

        document.getElementById("activeTasks").textContent = active;
        document.getElementById("completedTasks").textContent = completed;
        document.getElementById("totalTasks").textContent = tasks.length;
        document.getElementById("totalTime").textContent =
          totalTime.toFixed(1) + "h";
        document.getElementById("taskCount").textContent = tasks.length;
      }

      function renderTasks(tasks) {
        const container = document.getElementById("tasksContainer");
        const emptyState = document.getElementById("emptyState");

        // Filter tasks based on current filter
        let filteredTasks = tasks;
        if (technicianState.currentFilter !== "all") {
          filteredTasks = tasks.filter(
            (t) => t.status === technicianState.currentFilter
          );
        }

        if (filteredTasks.length === 0) {
          container.innerHTML = "";
          emptyState.classList.remove("d-none");
          return;
        }

        emptyState.classList.add("d-none");

        container.innerHTML = filteredTasks
          .map(
            (task, index) => `
                <div class="col-md-6 col-xl-4" style="animation-delay: ${
                  index * 0.1
                }s">
                    ${renderTaskCard(task)}
                </div>
            `
          )
          .join("");
      }

      function renderTaskCard(task) {
        const categoryIcons = {
          Water: "fa-tint",
          Road: "fa-road",
          Waste: "fa-trash",
          Light: "fa-lightbulb",
        };

        const categoryClasses = {
          Water: "category-water",
          Road: "category-road",
          Waste: "category-waste",
          Light: "category-light",
        };

        const priorityClass = `priority-${task.priority || "normal"}`;
        const statusClass = `status-${task.status}`;
        const icon = categoryIcons[task.category] || "fa-wrench";
        const catClass = categoryClasses[task.category] || "";

        const isInProgress = task.status === "in-progress";
        const isResolved =
          task.status === "resolved" || task.status === "completed";

        return `
                <div class="task-card" data-task-id="${task.id}">
                    <div class="task-card-header">
                        <span class="task-id">${task.id}</span>
                        <div class="d-flex gap-2 align-items-center">
                            <span class="task-priority ${priorityClass}">${
          task.priority || "Normal"
        }</span>
                            <span class="task-status ${statusClass}">${ComplaintService.getStatusLabel(
          task.status
        )}</span>
                        </div>
                    </div>
                    <div class="task-card-body">
                        <span class="task-category ${catClass}">
                            <i class="fas ${icon}"></i>
                            ${task.categoryLabel || task.category}
                        </span>
                        <h6 class="task-title">${
                          task.categoryLabel || task.category
                        } Issue</h6>
                        <p class="task-description">${truncateText(
                          task.description,
                          100
                        )}</p>
                        <div class="task-location">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${task.location}</span>
                        </div>
                        <div class="task-meta">
                            <div class="task-meta-item">
                                <i class="fas fa-calendar"></i>
                                ${ComplaintService.formatDate(task.createdAt)}
                            </div>
                            ${
                              task.totalTimeSpent
                                ? `
                            <div class="task-meta-item">
                                <i class="fas fa-clock"></i>
                                ${task.totalTimeSpent}h spent
                            </div>
                            `
                                : ""
                            }
                            <div class="task-meta-item">
                                <i class="fas fa-user"></i>
                                ${task.citizen.name}
                            </div>
                        </div>
                    </div>
                    <div class="task-card-actions">
                        <button class="btn-tech-outline flex-grow-1" onclick="viewTaskDetail('${
                          task.id
                        }')">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                        ${
                          !isResolved
                            ? `
                            ${
                              isInProgress
                                ? `
                                <button class="btn-tech-warning" onclick="quickUpdate('${task.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-tech-success" onclick="quickComplete('${task.id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                            `
                                : `
                                <button class="btn-tech-primary" onclick="startWork('${task.id}')">
                                    <i class="fas fa-play"></i> Start
                                </button>
                            `
                            }
                        `
                            : `
                            <span class="text-success d-flex align-items-center gap-1">
                                <i class="fas fa-check-circle"></i> Completed
                            </span>
                        `
                        }
                    </div>
                </div>
            `;
      }

      // ============================================
      // FILTER FUNCTIONALITY
      // ============================================
      function setupFilterPills() {
        document.querySelectorAll(".filter-pill").forEach((pill) => {
          pill.addEventListener("click", function () {
            document
              .querySelectorAll(".filter-pill")
              .forEach((p) => p.classList.remove("active"));
            this.classList.add("active");
            technicianState.currentFilter = this.dataset.filter;
            loadTasks();
          });
        });
      }

      // Switch to Complete filter programmatically
      function switchToCompleteFilter() {
        // Update UI - remove active from all pills
        document.querySelectorAll(".filter-pill").forEach((p) => {
          p.classList.remove("active");
          if (p.dataset.filter === "completed") {
            p.classList.add("active");
          }
        });

        // Update state
        technicianState.currentFilter = "completed";

        // Reload tasks with new filter
        loadTasks();
      }

      // ============================================
      // TASK DETAIL VIEW
      // ============================================
      function viewTaskDetail(taskId) {
        const task = ComplaintService.getComplaintById(taskId);
        if (!task) return;

        technicianState.selectedTask = task;

        // Update modal content
        document.getElementById("modalTaskId").textContent = task.id;
        document.getElementById("modalDescription").textContent =
          task.description;
        document.getElementById("modalLocation").textContent = task.location;

        // Category
        const categoryIcons = {
          Water: "fa-tint",
          Road: "fa-road",
          Waste: "fa-trash",
          Light: "fa-lightbulb",
        };
        const categoryClasses = {
          Water: "category-water",
          Road: "category-road",
          Waste: "category-waste",
          Light: "category-light",
        };
        const catEl = document.getElementById("modalCategory");
        catEl.className = `task-category ${
          categoryClasses[task.category] || ""
        }`;
        catEl.innerHTML = `<i class="fas ${
          categoryIcons[task.category] || "fa-wrench"
        }"></i> ${task.categoryLabel || task.category}`;

        // Status
        const statusEl = document.getElementById("modalStatus");
        statusEl.className = `task-status status-${task.status}`;
        statusEl.textContent = ComplaintService.getStatusLabel(task.status);

        // Priority
        const priorityEl = document.getElementById("modalPriority");
        priorityEl.className = `task-priority priority-${
          task.priority || "normal"
        }`;
        priorityEl.textContent =
          (task.priority || "normal").charAt(0).toUpperCase() +
          (task.priority || "normal").slice(1);

        // Dates
        document.getElementById("modalAssignedDate").textContent =
          ComplaintService.formatDate(task.updatedAt || task.createdAt);
        document.getElementById("modalTimeSpent").textContent =
          (task.totalTimeSpent || 0) + " hours";

        // Citizen info
        document.getElementById("modalCitizenAvatar").textContent =
          task.citizen.initials;
        document.getElementById("modalCitizenName").textContent =
          task.citizen.name;
        document.getElementById("modalCitizenPhone").textContent =
          task.citizen.phone;

        // Timeline
        renderModalTimeline(task.id);

        // Action buttons visibility
        const actionsEl = document.getElementById("modalActions");
        if (task.status === "resolved") {
          actionsEl.innerHTML = `
                    <span class="text-success d-flex align-items-center gap-2">
                        <i class="fas fa-check-circle"></i>
                        This task has been completed
                    </span>
                `;
        } else if (task.status === "in-progress") {
          actionsEl.innerHTML = `
                    <button type="button" class="btn-tech-warning" onclick="openProgressModal()">
                        <i class="fas fa-edit"></i> Post Update
                    </button>
                    <button type="button" class="btn-tech-success" onclick="openCompleteModal()">
                        <i class="fas fa-check"></i> Mark Complete
                    </button>
                `;
        } else {
          actionsEl.innerHTML = `
                    <button type="button" class="btn-tech-primary" onclick="startWorkFromDetail()">
                        <i class="fas fa-play"></i> Start Working
                    </button>
                `;
        }

        taskDetailModal.show();
      }

      function renderModalTimeline(taskId) {
        const timeline = ComplaintService.getTimeline(taskId);
        const container = document.getElementById("modalTimeline");

        if (timeline.length === 0) {
          container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <p class="mb-0 small">No timeline entries yet</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = timeline
          .map((entry) => {
            const config = ComplaintService.getTimelineTypeConfig(entry.type);
            return `
                    <div class="timeline-item">
                        <div class="timeline-marker" style="background: ${
                          config.bgColor
                        };">
                            <i class="fas ${config.icon}" style="color: ${
              config.color
            }; font-size: 12px;"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-date">${ComplaintService.formatDateTime(
                              entry.timestamp
                            )}</div>
                            <div class="timeline-title">${entry.title}</div>
                            <div class="timeline-description">${
                              entry.description
                            }</div>
                            ${
                              entry.actor
                                ? `<div class="small text-muted mt-1"><i class="fas fa-user me-1"></i>${entry.actor}</div>`
                                : ""
                            }
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // ============================================
      // START WORK
      // ============================================
      function startWork(taskId) {
        const task = ComplaintService.getComplaintById(taskId);
        if (!task) return;

        technicianState.selectedTask = task;
        document.getElementById("startWorkTaskId").textContent = task.id;
        startWorkModal.show();
      }

      function startWorkFromDetail() {
        if (!technicianState.selectedTask) return;
        taskDetailModal.hide();
        setTimeout(() => {
          document.getElementById("startWorkTaskId").textContent =
            technicianState.selectedTask.id;
          startWorkModal.show();
        }, 300);
      }

      async function confirmStartWork() {
        if (!technicianState.selectedTask) return;

        const btn = document.getElementById("confirmStartBtn");
        btn.classList.add("btn-loading");
        btn.disabled = true;

        try {
          // Update status to "in-progress" in MongoDB
          const taskId = technicianState.selectedTask.id;
          const result = await ApiService.updateComplaintStatus(
            taskId,
            "in-progress",
            technicianState.name,
            "technician",
            `Work started by ${technicianState.name}`
          );

          if (result && result.success) {
            // Also update local storage for sync
            ComplaintService.startTask(taskId, technicianState.name);

            ComplaintService.showNotification(
              ` Started working on task ${taskId} - Status: In Progress`,
              "success"
            );
            startWorkModal.hide();
            loadTasks();
          } else {
            throw new Error(result?.error || "Failed to update status");
          }
        } catch (err) {
          console.error("Error starting work:", err);
          ComplaintService.showNotification(
            err.message || "Failed to start task. Please try again.",
            "danger"
          );
        } finally {
          btn.classList.remove("btn-loading");
          btn.disabled = false;
        }
      }

      // ============================================
      // PROGRESS UPDATE
      // ============================================
      function openProgressModal() {
        // Clear form
        document.getElementById("progressNotes").value = "";
        document.getElementById("progressTime").value = "";
        document.getElementById("progressPreview").innerHTML = "";
        technicianState.uploadedPhotos = [];

        taskDetailModal.hide();
        setTimeout(() => progressModal.show(), 300);
      }

      function quickUpdate(taskId) {
        const task = ComplaintService.getComplaintById(taskId);
        if (!task) return;
        technicianState.selectedTask = task;
        openProgressModal();
      }

      async function submitProgressUpdate() {
        const notes = document.getElementById("progressNotes").value.trim();
        const time =
          parseFloat(document.getElementById("progressTime").value) || 0;

        if (!notes) {
          ComplaintService.showNotification(
            "Please enter work notes",
            "warning"
          );
          return;
        }

        const btn = document.getElementById("submitProgressBtn");
        btn.classList.add("btn-loading");
        btn.disabled = true;

        try {
          const taskId = technicianState.selectedTask.id;

          // Save progress update to MongoDB
          const result = await ApiService.addProgressUpdate(
            taskId,
            notes,
            time,
            technicianState.name
          );

          if (result && result.success) {
            // Also update local storage for sync
            ComplaintService.addProgressUpdate(taskId, {
              notes: notes,
              timeSpent: time,
              photos: technicianState.uploadedPhotos,
              technician: technicianState.name,
            });

            ComplaintService.showNotification(
              " Progress update saved to database!",
              "success"
            );
            progressModal.hide();
            loadTasks();

            // Refresh detail modal if it was open
            if (technicianState.selectedTask) {
              technicianState.selectedTask =
                result.data || technicianState.selectedTask;
            }
          } else {
            throw new Error(result?.error || "Failed to post update");
          }
        } catch (err) {
          console.error("Error posting progress:", err);
          ComplaintService.showNotification(
            err.message || "Failed to post update. Please try again.",
            "danger"
          );
        } finally {
          btn.classList.remove("btn-loading");
          btn.disabled = false;
        }
      }

      // ============================================
      // COMPLETE TASK
      // ============================================
      function openCompleteModal() {
        // Clear form
        document.getElementById("completeNotes").value = "";
        document.getElementById("completeTime").value = "";
        document.getElementById("completePreview").innerHTML = "";
        technicianState.uploadedPhotos = [];

        taskDetailModal.hide();
        setTimeout(() => completeModal.show(), 300);
      }

      function quickComplete(taskId) {
        const task = ComplaintService.getComplaintById(taskId);
        if (!task) return;
        technicianState.selectedTask = task;
        openCompleteModal();
      }

      async function submitCompletion() {
        const notes = document.getElementById("completeNotes").value.trim();
        const time =
          parseFloat(document.getElementById("completeTime").value) || 0;

        if (!notes) {
          ComplaintService.showNotification(
            "Please enter completion notes",
            "warning"
          );
          return;
        }

        const btn = document.getElementById("submitCompleteBtn");
        btn.classList.add("btn-loading");
        btn.disabled = true;

        try {
          const taskId = technicianState.selectedTask.id;

          // First add the progress update to MongoDB
          await ApiService.addProgressUpdate(
            taskId,
            notes,
            time,
            technicianState.name
          );

          // Then update status to "completed" in MongoDB
          const result = await ApiService.updateComplaintStatus(
            taskId,
            "completed",
            technicianState.name,
            "technician",
            `Task completed by ${technicianState.name}. Notes: ${notes}`
          );

          if (result && result.success) {
            // Also update local storage for sync
            ComplaintService.markTaskCompleted(taskId, {
              notes: notes,
              timeSpent: time,
              photos: technicianState.uploadedPhotos,
              technician: technicianState.name,
            });

            ComplaintService.showNotification(
              ` Task ${taskId} marked as Complete!`,
              "success"
            );
            completeModal.hide();

            // Switch to "Complete" filter to show the completed task
            switchToCompleteFilter();

            technicianState.selectedTask = null;
          } else {
            throw new Error(result?.error || "Failed to complete task");
          }
        } catch (err) {
          console.error("Error completing task:", err);
          ComplaintService.showNotification(
            err.message || "Failed to complete task. Please try again.",
            "danger"
          );
        } finally {
          btn.classList.remove("btn-loading");
          btn.disabled = false;
        }
      }

      // ============================================
      // PHOTO UPLOAD
      // ============================================
      function handlePhotoUpload(input, previewId) {
        const preview = document.getElementById(previewId);
        const files = input.files;

        Array.from(files).forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            const photoId = "photo-" + Date.now() + "-" + index;
            technicianState.uploadedPhotos.push({
              id: photoId,
              data: e.target.result,
              name: file.name,
            });

            preview.innerHTML += `
                        <div class="photo-preview-item" id="${photoId}">
                            <img src="${e.target.result}" alt="Preview">
                            <button class="remove-photo" onclick="removePhoto('${photoId}', '${previewId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
          };
          reader.readAsDataURL(file);
        });
      }

      function removePhoto(photoId, previewId) {
        technicianState.uploadedPhotos = technicianState.uploadedPhotos.filter(
          (p) => p.id !== photoId
        );
        document.getElementById(photoId)?.remove();
      }

      // ============================================
      // REAL-TIME UPDATES
      // ============================================
      function handleRealTimeUpdate(type, data) {
        console.log("Real-time update:", type, data);

        // Normalize IDs and complaint object
        const complaintId = data.complaintId || data.id || data._id;
        const complaint = data.complaint || data;
        const assignedTo = complaint?.assignedTo || data.technician;

        switch (type) {
          case "TASK_ASSIGNED":
          case "COMPLAINT_ASSIGNED":
            if (assignedTo && assignedTo.id === technicianState.id) {
              const notifKey = `${type}_${complaintId || "unknown"}`;
              if (processedNotificationKeys.has(notifKey)) break;
              processedNotificationKeys.add(notifKey);
              setTimeout(
                () => processedNotificationKeys.delete(notifKey),
                30000
              );

              loadTasks();
              const taskMsg = ` New task assigned: ${
                complaint.categoryLabel || complaint.category
              } - ${complaint.location || ""}`;
              ComplaintService.showNotification(taskMsg, "info");
              addNotification(taskMsg, "primary", notifKey);
              setTimeout(() => {
                const taskCard = document.querySelector(
                  `[data-task-id="${complaintId}"]`
                );
                if (taskCard) {
                  taskCard.classList.add("new-highlight");
                  taskCard.scrollIntoView({
                    behavior: "smooth",
                    block: "center",
                  });
                }
              }, 500);
            }
            break;

          case "TASK_REASSIGNED":
            if (
              data.newTechnician &&
              data.newTechnician.id === technicianState.id
            ) {
              const notifKey = `${type}_new_${complaintId || "unknown"}`;
              if (processedNotificationKeys.has(notifKey)) break;
              processedNotificationKeys.add(notifKey);
              setTimeout(
                () => processedNotificationKeys.delete(notifKey),
                30000
              );

              loadTasks();
              const reassignMsg = ` Task reassigned to you: ${
                complaint.categoryLabel || complaint.category
              }`;
              ComplaintService.showNotification(reassignMsg, "info");
              addNotification(reassignMsg, "info", notifKey);
            } else if (
              data.oldTechnician &&
              data.oldTechnician.id === technicianState.id
            ) {
              const notifKey = `${type}_old_${complaintId || "unknown"}`;
              if (processedNotificationKeys.has(notifKey)) break;
              processedNotificationKeys.add(notifKey);
              setTimeout(
                () => processedNotificationKeys.delete(notifKey),
                30000
              );

              loadTasks();
              const removedMsg = `Task ${complaintId} has been reassigned to another technician`;
              ComplaintService.showNotification(removedMsg, "warning");
              addNotification(removedMsg, "warning", notifKey);
              if (
                technicianState.selectedTask &&
                technicianState.selectedTask.id === complaintId
              ) {
                taskDetailModal.hide();
                technicianState.selectedTask = null;
              }
            }
            break;

          case "COMPLAINT_UPDATED":
          case "STATUS_CHANGED":
          case "COMPLAINT_STATUS_CHANGED":
            if (
              complaint &&
              complaint.assignedTo &&
              complaint.assignedTo.id === technicianState.id
            ) {
              loadTasks();
              const newStatus =
                data.newStatus || data.status || complaint.status;
              const notifKey = `STATUS_${complaintId || "unknown"}_${
                data.newStatus || data.status || complaint.status
              }`;
              if (processedNotificationKeys.has(notifKey)) break;
              processedNotificationKeys.add(notifKey);
              setTimeout(
                () => processedNotificationKeys.delete(notifKey),
                30000
              );

              const statusMsg = `Task #${complaintId} status updated to ${ComplaintService.getStatusLabel(
                newStatus
              )}`;
              ComplaintService.showNotification(statusMsg, "info");
              addNotification(statusMsg, "info", notifKey);
              if (
                technicianState.selectedTask &&
                technicianState.selectedTask.id ===
                  (complaintId || complaint.id)
              ) {
                technicianState.selectedTask = complaint;
                viewTaskDetail(complaint.id);
              }
            }
            break;

          case "TASK_STARTED":
            if (
              complaint &&
              complaint.assignedTo &&
              complaint.assignedTo.id === technicianState.id
            ) {
              loadTasks();
              addNotification(`Task #${complaintId} work started`, "success");
            }
            break;

          case "TASK_COMPLETED":
            if (
              complaint &&
              complaint.assignedTo &&
              complaint.assignedTo.id === technicianState.id
            ) {
              loadTasks();
              const completeMsg = ` Task #${complaintId} completed successfully!`;
              ComplaintService.showNotification(completeMsg, "success");
              addNotification(completeMsg, "success");
            }
            break;

          case "PROGRESS_UPDATE":
            if (
              complaint &&
              complaint.assignedTo &&
              complaint.assignedTo.id === technicianState.id
            ) {
              loadTasks();
              addNotification(
                `Progress update on task #${complaintId}`,
                "info"
              );
            }
            break;

          case "TIMELINE_UPDATED":
            if (
              technicianState.selectedTask &&
              complaintId === technicianState.selectedTask.id
            ) {
              renderModalTimeline(complaintId);
            }
            break;

          case "STATS_UPDATED":
          case "DATA_RESET":
            loadTasks();
            break;
        }
      }

      // ============================================
      // UTILITIES
      // ============================================
      function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substr(0, maxLength) + "...";
      }

      function logout() {
        sessionStorage.clear();
        window.location.href = "index.html";
      }

      // ============================================
      // NOTIFICATION FUNCTIONS
      // ============================================

      // Add notification to dropdown
      // Save notifications to localStorage
      function saveNotificationsToLocal() {
        try {
          const notificationsToSave = notifications.map((n) => ({
            message: n.message,
            type: n.type,
            time: n.time instanceof Date ? n.time.toISOString() : n.time,
          }));
          localStorage.setItem(
            NOTIFICATIONS_STORAGE_KEY,
            JSON.stringify(notificationsToSave)
          );
        } catch (err) {
          console.error("Failed to save notifications to localStorage:", err);
        }
      }

      // Load notifications from localStorage
      function loadNotificationsFromLocal() {
        try {
          const stored = localStorage.getItem(NOTIFICATIONS_STORAGE_KEY);
          if (stored) {
            const parsed = JSON.parse(stored);
            notifications = parsed.map((n) => ({
              message: n.message,
              type: n.type,
              time: n.time ? new Date(n.time) : new Date(),
            }));
            notificationCount = notifications.length;
            updateNotificationDropdown();
            return true;
          }
        } catch (err) {
          console.error("Failed to load notifications from localStorage:", err);
        }
        return false;
      }

      function addNotification(message, type = "info", key = null) {
        if (key && processedNotificationKeys.has(key)) return;
        if (key) {
          processedNotificationKeys.add(key);
          setTimeout(() => processedNotificationKeys.delete(key), 30000);
        }
        notifications.unshift({ message, type, time: new Date() });
        notificationCount++;
        updateNotificationDropdown();
        saveNotificationsToLocal(); // Save to localStorage
      }

      // Update notification dropdown
      function updateNotificationDropdown() {
        const badge = document.getElementById("notificationBadge");
        const notifBody = document.getElementById("notificationBody");
        const noNotif = document.getElementById("noNotifications");

        if (!badge || !notifBody) {
          console.warn("Notification elements not found");
          return;
        }

        // Update badge
        badge.textContent = notificationCount;
        if (notificationCount > 0) {
          badge.classList.remove("hidden");
        } else {
          badge.classList.add("hidden");
        }

        if (notifications.length > 0) {
          if (noNotif) noNotif.style.display = "none";

          // Clear old items
          const items = notifBody.querySelectorAll(".notification-item");
          items.forEach((item) => item.remove());

          // Add new items with beautiful styling
          notifications.slice(0, 5).forEach((notif) => {
            const iconMap = {
              danger: { icon: "fa-exclamation-circle", class: "danger" },
              success: { icon: "fa-check-circle", class: "success" },
              info: { icon: "fa-info-circle", class: "info" },
              warning: { icon: "fa-exclamation-triangle", class: "warning" },
            };
            const iconData = iconMap[notif.type] || iconMap.info;

            const div = document.createElement("div");
            div.className = "notification-item";
            div.innerHTML = `
              <div class="notification-icon-wrapper ${iconData.class}">
                <i class="fas ${iconData.icon}"></i>
              </div>
              <div class="notification-content">
                <div class="message">${notif.message}</div>
                <div class="time">
                  <i class="far fa-clock"></i>
                  ${formatTimeAgo(notif.time)}
                </div>
              </div>
            `;
            notifBody.appendChild(div);
          });
        } else {
          if (noNotif) noNotif.style.display = "block";
        }
      }

      // Clear notifications
      function clearNotifications() {
        clearNotificationsFromServer();
      }

      async function loadNotifications() {
        try {
          const res = await ApiService.getNotifications("technician");
          if (res && res.success && Array.isArray(res.data)) {
            notifications = res.data.map((n) => ({
              message: n.message || "Notification",
              type: n.type || "info",
              time: n.createdAt ? new Date(n.createdAt) : new Date(),
            }));
            notificationCount = notifications.length;
            updateNotificationDropdown();
            saveNotificationsToLocal(); // Save API notifications to localStorage
          } else {
            // If API fails, load from localStorage
            loadNotificationsFromLocal();
          }
        } catch (err) {
          console.error("Failed to load notifications from API:", err);
          // Fallback to localStorage
          loadNotificationsFromLocal();
        }
      }

      async function clearNotificationsFromServer() {
        try {
          const res = await ApiService.clearNotifications("technician");
          if (res && res.success !== false) {
            notifications = [];
            notificationCount = 0;
            updateNotificationDropdown();
            // Also clear from localStorage
            localStorage.removeItem(NOTIFICATIONS_STORAGE_KEY);
          } else {
            ComplaintService.showNotification(
              res?.error || "Failed to clear notifications",
              "warning"
            );
          }
        } catch (err) {
          console.error("Failed to clear notifications:", err);
          // Clear from localStorage even if API fails
          notifications = [];
          notificationCount = 0;
          updateNotificationDropdown();
          localStorage.removeItem(NOTIFICATIONS_STORAGE_KEY);
        }
      }

      // Format time ago helper
      function formatTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return "Just now";
        if (seconds < 3600) return Math.floor(seconds / 60) + " min ago";
        if (seconds < 86400) return Math.floor(seconds / 3600) + " hours ago";
        return Math.floor(seconds / 86400) + " days ago";
      }

      // ============================================
      // PROFILE DRAWER FUNCTIONALITY
      // ============================================

      let currentUserData = null;
      let isDrawerOpen = false;

      async function openProfileDrawer() {
        const drawer = document.getElementById("profileDrawer");
        const overlay = document.getElementById("profileDrawerOverlay");

        // Load fresh data from MongoDB
        await loadUserDataToDrawer();

        overlay.classList.add("active");
        drawer.classList.add("active");
        isDrawerOpen = true;

        document.body.style.overflow = "hidden";
        document.addEventListener("keydown", handleEscapeKey);
      }

      function closeProfileDrawer() {
        const drawer = document.getElementById("profileDrawer");
        const overlay = document.getElementById("profileDrawerOverlay");

        drawer.classList.remove("active");
        overlay.classList.remove("active");
        isDrawerOpen = false;

        document.body.style.overflow = "";
        document.removeEventListener("keydown", handleEscapeKey);
        resetFormValidation();
      }

      function handleEscapeKey(e) {
        if (e.key === "Escape" && isDrawerOpen) {
          closeProfileDrawer();
        }
      }

      async function loadUserDataToDrawer() {
        const userId = sessionStorage.getItem("userId");
        const userEmail =
          sessionStorage.getItem("userEmail") || "technician@demo.com";
        const userName =
          sessionStorage.getItem("userName") || technicianState.name;
        const techId =
          sessionStorage.getItem("technicianId") || technicianState.id;

        // Try to load from MongoDB first
        if (userId && typeof ApiService !== "undefined") {
          try {
            const userData = await ApiService.getUserById(userId);
            if (userData) {
              currentUserData = userData;
              console.log("Loaded user from MongoDB:", currentUserData);
            }
          } catch (err) {
            console.error("Error loading user from API:", err);
          }
        }

        // Fallback to session storage data if API fails
        if (!currentUserData) {
          currentUserData = {
            id: userId || "USR-003",
            name: userName,
            email: userEmail,
            phone: sessionStorage.getItem("userPhone") || "",
            technicianId: techId,
            department: sessionStorage.getItem("department") || "Electrical",
            specialty:
              sessionStorage.getItem("specialty") || "Electrical Specialist",
            password: "",
            createdAt:
              sessionStorage.getItem("userCreatedAt") ||
              new Date().toISOString(),
          };
        }

        document.getElementById("profileName").value =
          currentUserData.name || "";
        document.getElementById("profileEmail").value =
          currentUserData.email || "";
        document.getElementById("profilePhone").value =
          currentUserData.phone || "";
        document.getElementById("profileTechId").value =
          currentUserData.technicianId || techId || "";
        document.getElementById("profileDepartment").value =
          currentUserData.department || "";
        document.getElementById("profileSpecialty").value =
          currentUserData.specialty || "";
        document.getElementById("profileUserId").value =
          currentUserData.id || currentUserData._id || "";
        document.getElementById("profileCreatedAt").value = formatMemberSince(
          currentUserData.createdAt
        );

        const initials = ApiService.getInitials
          ? ApiService.getInitials(currentUserData.name)
          : ComplaintService.getInitials(currentUserData.name);
        document.getElementById("drawerAvatar").textContent = initials;
        document.getElementById("drawerName").textContent =
          currentUserData.name;

        document.getElementById("profileCurrentPassword").value = "";
        document.getElementById("profileNewPassword").value = "";
        document.getElementById("profileConfirmPassword").value = "";
      }

      function formatMemberSince(isoString) {
        if (!isoString) return "N/A";
        const date = new Date(isoString);
        const options = { year: "numeric", month: "long", day: "numeric" };
        return date.toLocaleDateString("en-US", options);
      }

      function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const icon = input.nextElementSibling.querySelector("i");

        if (input.type === "password") {
          input.type = "text";
          icon.classList.remove("fa-eye");
          icon.classList.add("fa-eye-slash");
        } else {
          input.type = "password";
          icon.classList.remove("fa-eye-slash");
          icon.classList.add("fa-eye");
        }
      }

      function validateProfileForm() {
        let isValid = true;
        resetFormValidation();

        const nameInput = document.getElementById("profileName");
        const nameValue = nameInput.value.trim();
        if (!nameValue || nameValue.length < 2 || nameValue.length > 50) {
          nameInput.classList.add("is-invalid");
          isValid = false;
        }

        const phoneInput = document.getElementById("profilePhone");
        const phoneValue = phoneInput.value.trim();
        if (
          phoneValue &&
          !/^[\+]?[0-9\s\-]{10,15}$/.test(phoneValue.replace(/\s/g, ""))
        ) {
          phoneInput.classList.add("is-invalid");
          isValid = false;
        }

        const currentPassword = document.getElementById(
          "profileCurrentPassword"
        ).value;
        const newPassword = document.getElementById("profileNewPassword").value;
        const confirmPassword = document.getElementById(
          "profileConfirmPassword"
        ).value;

        if (newPassword || confirmPassword) {
          if (!currentPassword) {
            document
              .getElementById("profileCurrentPassword")
              .classList.add("is-invalid");
            isValid = false;
          } else if (
            currentUserData &&
            currentPassword !== currentUserData.password
          ) {
            document
              .getElementById("profileCurrentPassword")
              .classList.add("is-invalid");
            isValid = false;
          }

          if (newPassword && newPassword.length < 6) {
            document
              .getElementById("profileNewPassword")
              .classList.add("is-invalid");
            isValid = false;
          }

          if (newPassword !== confirmPassword) {
            document
              .getElementById("profileConfirmPassword")
              .classList.add("is-invalid");
            isValid = false;
          }
        }

        return isValid;
      }

      function resetFormValidation() {
        const inputs = document.querySelectorAll("#profileForm input");
        inputs.forEach((input) => {
          input.classList.remove("is-invalid");
        });
      }

      async function saveProfile() {
        if (!validateProfileForm()) {
          showProfileToast("Please fix the errors in the form", "error");
          return;
        }

        const saveBtn = document.getElementById("saveProfileBtn");
        const originalContent = saveBtn.innerHTML;

        saveBtn.disabled = true;
        saveBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status"></span> Saving...';

        const updates = {
          name: document.getElementById("profileName").value.trim(),
          phone: document.getElementById("profilePhone").value.trim(),
          department: document.getElementById("profileDepartment").value.trim(),
          specialty: document.getElementById("profileSpecialty").value.trim(),
        };

        const newPassword = document.getElementById("profileNewPassword").value;
        if (newPassword) {
          updates.password = newPassword;
        }

        try {
          // Get user ID from session
          const userId = sessionStorage.getItem("userId");

          if (!userId) {
            throw new Error("User ID not found. Please log in again.");
          }

          // Update via API (saves to MongoDB)
          const result = await ApiService.updateUser(userId, updates);

          if (result) {
            console.log("Profile updated in MongoDB:", result);

            // Update local data
            if (currentUserData) {
              currentUserData = { ...currentUserData, ...updates };
            }

            sessionStorage.setItem("userName", updates.name);
            if (updates.phone) {
              sessionStorage.setItem("userPhone", updates.phone);
            }
            if (updates.department) {
              sessionStorage.setItem("department", updates.department);
            }
            if (updates.specialty) {
              sessionStorage.setItem("specialty", updates.specialty);
            }

            // Update technician state
            technicianState.name = updates.name;
            technicianState.initials = ApiService.getInitials
              ? ApiService.getInitials(updates.name)
              : ComplaintService.getInitials(updates.name);

            // Update UI elements
            document.getElementById("userName").textContent = updates.name;
            document.getElementById("userAvatar").textContent =
              technicianState.initials;
            document.getElementById("drawerAvatar").textContent =
              technicianState.initials;
            document.getElementById("drawerName").textContent = updates.name;

            showProfileToast(
              "Profile saved to database successfully!",
              "success"
            );

            document.getElementById("profileCurrentPassword").value = "";
            document.getElementById("profileNewPassword").value = "";
            document.getElementById("profileConfirmPassword").value = "";

            setTimeout(() => {
              closeProfileDrawer();
            }, 1000);
          } else {
            throw new Error("Failed to update profile in database");
          }
        } catch (error) {
          console.error("Error saving profile:", error);
          showProfileToast(
            error.message || "Failed to save profile. Please try again.",
            "error"
          );
        } finally {
          saveBtn.disabled = false;
          saveBtn.innerHTML = originalContent;
        }
      }

      function showProfileToast(message, type = "success") {
        const toast = document.getElementById("profileToast");
        const toastMessage = document.getElementById("profileToastMessage");
        const toastIcon = toast.querySelector("i");

        toastMessage.textContent = message;

        toast.classList.remove("error");
        toastIcon.className = "fas fa-check-circle me-2";

        if (type === "error") {
          toast.classList.add("error");
          toastIcon.className = "fas fa-exclamation-circle me-2";
        }

        toast.classList.add("show");

        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      // Real-time validation listeners for profile form
      (function setupProfileValidation() {
        document.addEventListener("DOMContentLoaded", function () {
          const nameInput = document.getElementById("profileName");
          if (nameInput) {
            nameInput.addEventListener("input", function () {
              if (this.value.trim().length >= 2) {
                this.classList.remove("is-invalid");
              }
            });
          }

          const phoneInput = document.getElementById("profilePhone");
          if (phoneInput) {
            phoneInput.addEventListener("input", function () {
              const value = this.value.trim().replace(/\s/g, "");
              if (!value || /^[\+]?[0-9\s\-]{10,15}$/.test(value)) {
                this.classList.remove("is-invalid");
              }
            });
          }

          const newPasswordInput =
            document.getElementById("profileNewPassword");
          const confirmPasswordInput = document.getElementById(
            "profileConfirmPassword"
          );

          if (newPasswordInput) {
            newPasswordInput.addEventListener("input", function () {
              if (!this.value || this.value.length >= 6) {
                this.classList.remove("is-invalid");
              }
              if (confirmPasswordInput && confirmPasswordInput.value) {
                if (this.value === confirmPasswordInput.value) {
                  confirmPasswordInput.classList.remove("is-invalid");
                }
              }
            });
          }

          if (confirmPasswordInput) {
            confirmPasswordInput.addEventListener("input", function () {
              if (newPasswordInput && this.value === newPasswordInput.value) {
                this.classList.remove("is-invalid");
              }
            });
          }
        });
      })();
    </script>
  </body>
</html>
